<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>bloop</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=IBM+Plex+Mono:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #09090B;
    --surface: #111114;
    --surface-raised: #16161A;
    --surface-hover: #1A1A1F;
    --border: #1E1E23;
    --border-bright: #2A2A32;
    --border-subtle: #16161C;
    --text: #E4E4E7;
    --text-secondary: #8B8B94;
    --text-dim: #52525B;
    --accent: #E8736C;
    --accent-glow: rgba(232, 115, 108, 0.12);
    --accent-soft: rgba(232, 115, 108, 0.08);
    --accent-text: #E8736C;
    --red: #C43830;
    --red-soft: rgba(196, 56, 48, 0.10);
    --red-text: #E85548;
    --red-glow: rgba(232, 85, 72, 0.06);
    --green: #5BB8A6;
    --green-soft: rgba(126, 207, 192, 0.10);
    --green-text: #7ECFC0;
    --muted-soft: rgba(139, 139, 148, 0.07);
    --display: 'DM Serif Display', Georgia, serif;
    --mono: 'IBM Plex Mono', 'SF Mono', 'Fira Code', monospace;
    --ease: cubic-bezier(0.22, 1, 0.36, 1);
    --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.3), 0 1px 3px rgba(0,0,0,0.15);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.25), 0 1px 3px rgba(0,0,0,0.2);
    --shadow-lg: 0 8px 30px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.2);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

  body {
    font-family: var(--mono);
    font-size: 13px;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
  }

  /* ── Atmospheric layers ── */
  body::before {
    content: '';
    position: fixed;
    top: -200px;
    left: 50%;
    transform: translateX(-50%);
    width: 1000px;
    height: 600px;
    background: radial-gradient(ellipse, rgba(232, 115, 108, 0.03) 0%, transparent 65%);
    pointer-events: none;
    z-index: 0;
  }

  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
    opacity: 0.6;
  }

  a { color: var(--accent-text); text-decoration: none; }
  a:hover { text-decoration: underline; text-underline-offset: 3px; }

  /* ── Header ── */
  .header {
    padding: 0 36px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    background: rgba(15, 15, 18, 0.85);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    position: sticky;
    top: 0;
    z-index: 50;
  }

  .header-brand {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .header-logo {
    height: 56px;
    opacity: 0.95;
    transition: opacity 0.2s;
  }
  .header-logo:hover { opacity: 1; }

  .header h1 { display: none; }

  .status {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 11px;
    color: var(--text-secondary);
    font-weight: 500;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }

  .status-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: var(--text-dim);
    flex-shrink: 0;
  }

  .status-dot.ok {
    background: var(--green-text);
    box-shadow: 0 0 8px rgba(126, 207, 192, 0.5), 0 0 2px rgba(126, 207, 192, 0.8);
    animation: pulse 3s ease-in-out infinite;
  }

  .status-dot.err {
    background: var(--red-text);
    box-shadow: 0 0 8px rgba(232, 85, 72, 0.5), 0 0 2px rgba(232, 85, 72, 0.8);
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.35; }
  }

  .logout-btn {
    font-family: var(--mono);
    font-size: 10px;
    font-weight: 600;
    color: var(--text-dim);
    background: transparent;
    border: 1px solid var(--border);
    padding: 5px 12px;
    border-radius: 6px;
    cursor: pointer;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    transition: all 0.2s var(--ease);
  }
  .logout-btn:hover {
    color: var(--text-secondary);
    border-color: var(--border-bright);
    background: var(--surface-raised);
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  /* ── Container ── */
  .container {
    max-width: 1120px;
    margin: 0 auto;
    padding: 36px 36px 48px;
    position: relative;
    z-index: 1;
  }

  /* ── Stats ── */
  .stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 44px;
  }

  .stat {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px 24px 22px;
    position: relative;
    overflow: hidden;
    animation: fadeUp 0.5s var(--ease-out) both;
    transition: border-color 0.25s, box-shadow 0.25s;
  }
  .stat:hover {
    border-color: var(--border-bright);
    box-shadow: var(--shadow-sm);
  }
  .stat::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent-glow), transparent);
    opacity: 0;
    transition: opacity 0.3s;
  }
  .stat:hover::before { opacity: 1; }

  .stat:nth-child(1) { animation-delay: 0ms; }
  .stat:nth-child(2) { animation-delay: 70ms; }
  .stat:nth-child(3) { animation-delay: 140ms; }
  .stat:nth-child(4) { animation-delay: 210ms; }

  .stat-value {
    font-family: var(--display);
    font-size: 36px;
    font-weight: 400;
    line-height: 1;
    color: var(--text);
    letter-spacing: -0.02em;
  }

  .stat-label {
    font-size: 10px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.12em;
    margin-top: 12px;
    font-weight: 600;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* ── Filters ── */
  .filters {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
    animation: fadeIn 0.4s var(--ease) 0.35s both;
  }

  .filters select, .filters input {
    font-family: var(--mono);
    font-size: 11px;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 8px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    -webkit-appearance: none;
  }
  .filters select:focus, .filters input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-soft);
  }
  .filters input::placeholder { color: var(--text-dim); }

  .filter-btn {
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 600;
    background: var(--accent);
    color: var(--bg);
    border: none;
    padding: 8px 18px;
    border-radius: 8px;
    cursor: pointer;
    letter-spacing: 0.04em;
    transition: all 0.15s;
    box-shadow: 0 1px 3px rgba(232, 115, 108, 0.2);
  }
  .filter-btn:hover {
    background: var(--accent-text);
    box-shadow: 0 2px 8px rgba(232, 115, 108, 0.3);
    transform: translateY(-1px);
  }
  .filter-btn:active { transform: translateY(0); }

  /* ── Error List ── */
  .error-list {
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    animation: fadeUp 0.5s var(--ease) 0.4s both;
    box-shadow: var(--shadow-sm);
  }

  .error-row {
    padding: 16px 22px;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 20px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-subtle);
    border-left: 3px solid transparent;
    transition: all 0.2s var(--ease);
    background: var(--surface);
  }
  .error-row:last-child { border-bottom: none; }
  .error-row:hover {
    background: var(--surface-hover);
    border-left-color: var(--accent);
    box-shadow: inset 0 0 0 0.5px var(--border-bright);
  }
  .error-row .main { min-width: 0; }

  .error-row .type-line { display: flex; align-items: center; gap: 10px; }

  .error-row .type {
    font-size: 10px;
    font-weight: 700;
    color: var(--red-text);
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .error-row .message {
    font-size: 12.5px;
    margin-top: 6px;
    color: var(--text);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    line-height: 1.5;
  }

  .error-row .meta {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 6px;
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
  }
  .error-row .meta span::after { content: '\00b7'; margin-left: 4px; color: var(--border-bright); }
  .error-row .meta span:last-child::after { content: ''; margin-left: 0; }

  .error-row .right {
    text-align: right;
    white-space: nowrap;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    justify-content: center;
    gap: 4px;
  }

  .error-row .count {
    font-family: var(--display);
    font-size: 26px;
    color: var(--text);
    line-height: 1;
  }

  .error-row .time { font-size: 10px; color: var(--text-dim); letter-spacing: 0.02em; }

  /* ── Badges ── */
  .badge {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }
  .badge.unresolved { background: var(--red-soft); color: var(--red-text); }
  .badge.resolved { background: var(--green-soft); color: var(--green-text); }
  .badge.ignored { background: var(--muted-soft); color: var(--text-secondary); }

  /* ── Detail Panel ── */
  .detail-panel { display: none; }
  .detail-panel.active { display: block; animation: fadeUp 0.4s var(--ease) both; }

  .detail-back {
    font-size: 11px;
    color: var(--text-secondary);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 20px;
    font-weight: 500;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    transition: color 0.15s;
    padding: 4px 0;
  }
  .detail-back:hover { color: var(--accent-text); }

  .detail-title {
    font-family: var(--display);
    font-size: 24px;
    font-weight: 400;
    line-height: 1.4;
    color: var(--text);
    margin-bottom: 24px;
    letter-spacing: -0.01em;
  }

  .detail-actions { display: flex; gap: 10px; margin-bottom: 32px; }

  .detail-actions button {
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 600;
    padding: 8px 20px;
    border-radius: 8px;
    cursor: pointer;
    border: 1px solid;
    background: transparent;
    transition: all 0.2s var(--ease);
    letter-spacing: 0.03em;
  }
  .btn-resolve { border-color: var(--green); color: var(--green-text); }
  .btn-resolve:hover { background: var(--green-soft); box-shadow: 0 0 0 3px rgba(58, 138, 80, 0.08); }
  .btn-ignore { border-color: var(--border-bright); color: var(--text-secondary); }
  .btn-ignore:hover { background: var(--muted-soft); }

  .detail-agg {
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 32px;
    box-shadow: var(--shadow-sm);
  }

  .detail-agg-item {
    font-size: 12px;
    color: var(--text-secondary);
    padding: 12px 18px;
    border-bottom: 1px solid var(--border-subtle);
    line-height: 1.6;
    background: var(--surface);
  }
  .detail-agg-item:last-child { border-bottom: none; }
  .detail-agg-item strong { color: var(--text); font-weight: 600; }

  .samples-heading {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-dim);
    margin-bottom: 14px;
  }

  .sample {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px 18px;
    margin-bottom: 10px;
    transition: border-color 0.2s;
  }
  .sample:hover { border-color: var(--border-bright); }

  .sample-meta {
    font-size: 11px;
    color: var(--text-dim);
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
  }
  .sample-meta span::after { content: '\00b7'; margin-left: 4px; color: var(--border-bright); }
  .sample-meta span:last-child::after { content: ''; margin-left: 0; }

  .sample pre {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-secondary);
    line-height: 1.7;
    overflow-x: auto;
    white-space: pre-wrap;
    word-break: break-all;
    margin-top: 12px;
    padding: 14px 16px;
    background: var(--bg);
    border-radius: 8px;
    border: 1px solid var(--border-subtle);
  }

  /* ── Empty & Loading ── */
  .empty {
    text-align: center;
    padding: 72px 24px;
    color: var(--text-dim);
    font-size: 12px;
    letter-spacing: 0.03em;
  }
  .empty::before {
    content: '\2014';
    display: block;
    font-family: var(--display);
    font-size: 42px;
    color: var(--border-bright);
    margin-bottom: 14px;
    line-height: 1;
  }
  .loading {
    text-align: center;
    padding: 56px;
    color: var(--text-dim);
    font-size: 11px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  /* ── Responsive ── */
  @media (max-width: 768px) {
    .container { padding: 24px 20px; }
    .header { padding: 0 20px; height: 56px; }
    .stats { grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .stat-value { font-size: 28px; }
    .error-row .right { gap: 2px; }
    .error-row .count { font-size: 20px; }
  }
  @media (max-width: 480px) {
    .stats { grid-template-columns: 1fr 1fr; gap: 10px; }
    .stat { padding: 18px 16px; }
    .stat-value { font-size: 24px; }
    .filters { gap: 6px; }
    .filters select, .filters input { font-size: 10px; padding: 6px 8px; }
  }

  /* ── Settings Panel ── */
  .settings-panel {
    position: fixed;
    top: 0; right: 0; bottom: 0;
    width: 440px;
    max-width: 100vw;
    background: var(--surface);
    border-left: 1px solid var(--border);
    z-index: 100;
    overflow-y: auto;
    animation: slideIn 0.35s var(--ease-out) both;
    box-shadow: -20px 0 60px rgba(0,0,0,0.4);
  }
  .settings-panel.hidden { display: none; }
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0.5; }
    to { transform: translateX(0); opacity: 1; }
  }
  .settings-inner { padding: 32px 28px; }
  .settings-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }
  .settings-title {
    font-family: var(--display);
    font-size: 22px;
    font-weight: 400;
  }
  .settings-section {
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }
  .settings-section-title {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-dim);
    font-weight: 600;
    margin-bottom: 16px;
  }
  .settings-list { display: flex; flex-direction: column; gap: 8px; }
  .settings-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
    font-size: 12px;
    transition: border-color 0.15s;
  }
  .settings-item:hover { border-color: var(--border-bright); }
  .settings-item .name { color: var(--text); font-weight: 500; }
  .settings-item .badge {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    padding: 2px 7px;
    border-radius: 4px;
    margin-left: 8px;
  }
  .badge-admin { background: var(--accent-soft); color: var(--accent-text); }
  .badge-used { background: var(--muted-soft); color: var(--text-dim); }
  .badge-active { background: var(--green-soft); color: var(--green-text); }
  .settings-item .remove-btn {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--red-text);
    background: var(--red-soft);
    border: none;
    padding: 4px 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: opacity 0.15s;
  }
  .settings-item .remove-btn:hover { opacity: 0.75; }
  .stack-toggle {
    font-family: var(--mono);
    font-size: 10px;
    padding: 2px 8px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.15s ease;
  }
  .stack-toggle:hover { color: var(--text-secondary); border-color: var(--border-bright); }
  .stack-toggle.active { color: var(--accent-text); border-color: var(--accent); background: var(--accent-soft); }
  .settings-btn {
    font-size: 11px;
    padding: 10px 18px;
    width: auto;
    margin-bottom: 14px;
  }
  .danger-btn {
    background: var(--red);
    border-color: var(--red);
    color: white;
  }
  .danger-btn:hover { background: #D04038; }
  .danger-zone { border-bottom: none; }
  .invite-result {
    background: var(--bg);
    border: 1px solid var(--accent);
    border-radius: 8px;
    padding: 12px 14px;
    margin-bottom: 14px;
    font-size: 11px;
    word-break: break-all;
    color: var(--accent-text);
    cursor: pointer;
    transition: background 0.15s;
  }
  .invite-result:hover { background: var(--accent-soft); }
  .invite-result.hidden { display: none; }
  .toast-container {
    position: fixed;
    top: 76px;
    right: 20px;
    z-index: 100;
    display: flex;
    flex-direction: column;
    gap: 8px;
    pointer-events: none;
  }
  .toast {
    font-family: var(--mono);
    font-size: 12px;
    padding: 10px 16px;
    border-radius: 8px;
    pointer-events: auto;
    animation: toastIn 0.3s var(--ease) both;
    max-width: 360px;
    box-shadow: var(--shadow-md);
  }
  .toast-success {
    background: var(--surface-raised);
    border: 1px solid var(--green);
    color: var(--green-text);
  }
  .toast-error {
    background: var(--surface-raised);
    border: 1px solid var(--red);
    color: var(--red-text);
  }
  .toast-info {
    background: var(--surface-raised);
    border: 1px solid var(--border-bright);
    color: var(--text-secondary);
  }
  .toast-exit { animation: toastOut 0.25s ease forwards; }
  @keyframes toastIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
  @keyframes toastOut { to { opacity: 0; transform: translateX(20px); } }
  .form-error-msg {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--red-text);
    margin-top: 4px;
  }
  .input-error { border-color: var(--red) !important; }
  .settings-note {
    font-size: 12px;
    color: var(--text-dim);
    padding: 24px 0;
  }

  /* ── Auth button (reused in settings) ── */
  .auth-btn {
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 600;
    background: var(--accent);
    color: var(--bg);
    border: 1px solid var(--accent);
    padding: 8px 18px;
    border-radius: 8px;
    cursor: pointer;
    letter-spacing: 0.04em;
    transition: all 0.15s;
  }
  .auth-btn:hover { background: var(--accent-text); }

  /* ── Scrollbar ── */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

  /* ── Trend Chart ── */
  .trend-section {
    margin-bottom: 32px;
    animation: fadeUp 0.5s var(--ease) 0.3s both;
  }
  .trend-header {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-dim);
    margin-bottom: 12px;
  }
  .trend-chart {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px 24px 16px;
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }
  .trend-chart svg { display: block; width: 100%; height: 120px; }

  /* ── Sparklines ── */
  .sparkline { display: inline-block; vertical-align: middle; margin-left: 8px; }
  .sparkline svg { display: block; }

  /* ── Muted badge ── */
  .badge.muted { background: var(--muted-soft); color: var(--text-dim); }

  /* ── Status timeline ── */
  .status-timeline { margin-top: 24px; }
  .timeline-entry {
    display: flex;
    align-items: baseline;
    gap: 10px;
    padding: 8px 0;
    font-size: 11px;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-subtle);
  }
  .timeline-entry:last-child { border-bottom: none; }
  .timeline-time { color: var(--text-dim); font-size: 10px; min-width: 80px; }

  /* ── Alert Management ── */
  .alert-item {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
    margin-bottom: 8px;
    transition: border-color 0.15s;
  }
  .alert-item:hover { border-color: var(--border-bright); }
  .alert-item-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
  }
  .alert-item-name { color: var(--text); font-weight: 600; font-size: 12px; }
  .alert-item-type { font-size: 9px; text-transform: uppercase; letter-spacing: 0.06em; }
  .alert-item-desc { font-size: 11px; color: var(--text-dim); margin-bottom: 8px; }
  .alert-item-actions { display: flex; gap: 6px; flex-wrap: wrap; }
  .alert-item-actions button {
    font-family: var(--mono);
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 4px;
    cursor: pointer;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-secondary);
    transition: all 0.15s;
  }
  .alert-item-actions button:hover {
    background: var(--surface-hover);
    border-color: var(--border-bright);
  }
  .alert-channel {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 10px;
    font-size: 11px;
    color: var(--text-secondary);
    background: var(--surface);
    border-radius: 4px;
    margin-top: 4px;
  }
  .alert-form {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 12px;
    padding: 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
  }
  .alert-form input, .alert-form select {
    font-family: var(--mono);
    font-size: 11px;
    padding: 6px 10px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    outline: none;
  }
  .alert-form input:focus, .alert-form select:focus {
    border-color: var(--accent);
  }
  /* ── Welcome Modal ── */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    z-index: 200;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease both;
  }
  .modal-overlay.hidden { display: none; }
  @keyframes fadeIn { from { opacity: 0; } }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border-bright);
    border-radius: 16px;
    width: 560px;
    max-width: 90vw;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 24px 80px rgba(0,0,0,0.5);
    animation: modalIn 0.35s var(--ease) both;
  }
  @keyframes modalIn { from { opacity: 0; transform: translateY(16px) scale(0.97); } }
  .modal-header {
    padding: 28px 32px 0;
    text-align: center;
  }
  .modal-header h2 {
    font-family: var(--display);
    font-size: 26px;
    color: var(--text);
    margin-bottom: 6px;
  }
  .modal-header p {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.5;
  }
  .modal-body { padding: 20px 32px 28px; }
  .modal-footer {
    padding: 0 32px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .modal-steps {
    display: flex;
    gap: 6px;
    justify-content: center;
    margin: 16px 0;
  }
  .modal-step-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--border-bright);
    transition: background 0.2s;
  }
  .modal-step-dot.active { background: var(--accent); }
  .snippet-tabs {
    display: flex;
    gap: 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: 12px;
    overflow-x: auto;
  }
  .snippet-tab {
    font-family: var(--mono);
    font-size: 11px;
    padding: 6px 12px;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--text-dim);
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.15s;
  }
  .snippet-tab:hover { color: var(--text-secondary); }
  .snippet-tab.active { color: var(--accent-text); border-bottom-color: var(--accent); }
  .snippet-code {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    font-family: var(--mono);
    font-size: 11px;
    line-height: 1.6;
    color: var(--text);
    overflow-x: auto;
    white-space: pre;
    position: relative;
  }
  .snippet-copy {
    position: absolute;
    top: 8px;
    right: 8px;
    font-family: var(--mono);
    font-size: 10px;
    padding: 3px 8px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text-dim);
    cursor: pointer;
  }
  .snippet-copy:hover { color: var(--text); border-color: var(--border-bright); }
  .api-key-display {
    background: var(--bg);
    border: 1px solid var(--accent);
    border-radius: 8px;
    padding: 12px 16px;
    font-family: var(--mono);
    font-size: 13px;
    color: var(--accent-text);
    cursor: pointer;
    text-align: center;
    transition: background 0.15s;
    word-break: break-all;
  }
  .api-key-display:hover { background: var(--accent-soft); }
  .api-key-label {
    font-size: 11px;
    color: var(--text-dim);
    text-align: center;
    margin-bottom: 6px;
  }
  .btn-modal {
    font-family: var(--mono);
    font-size: 12px;
    padding: 8px 20px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.15s;
  }
  .btn-modal-primary {
    background: var(--accent);
    color: #fff;
  }
  .btn-modal-primary:hover { background: var(--accent); filter: brightness(1.1); }
  .btn-modal-ghost {
    background: none;
    color: var(--text-dim);
    border: 1px solid var(--border);
  }
  .btn-modal-ghost:hover { color: var(--text); border-color: var(--border-bright); }
  .empty-state {
    text-align: center;
    padding: 48px 24px;
  }
  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 12px;
    opacity: 0.5;
  }
  .empty-state h3 {
    font-family: var(--display);
    font-size: 18px;
    color: var(--text);
    margin-bottom: 8px;
  }
  .empty-state p {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 16px;
    max-width: 360px;
    margin-left: auto;
    margin-right: auto;
  }
  .btn-empty {
    font-family: var(--mono);
    font-size: 12px;
    padding: 8px 20px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: filter 0.15s;
  }
  .btn-empty:hover { filter: brightness(1.1); }
  .btn-empty-ghost {
    font-family: var(--mono);
    font-size: 11px;
    padding: 6px 14px;
    background: none;
    color: var(--text-dim);
    border: 1px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    margin-left: 8px;
  }
  .btn-empty-ghost:hover { color: var(--text); border-color: var(--border-bright); }
  .pulse-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    background: var(--accent);
    border-radius: 50%;
    animation: pulse 1.5s ease infinite;
    margin-right: 6px;
    vertical-align: middle;
  }
  @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(0.8); } }
  .first-event-banner {
    text-align: center;
    padding: 16px;
    background: var(--green-soft);
    border: 1px solid var(--green);
    border-radius: 8px;
    margin: 12px 24px;
    animation: fadeIn 0.3s ease both;
  }
  .first-event-banner span { color: var(--green-text); font-size: 12px; }
  .snippet-section { margin-top: 12px; }
  .snippet-section-label {
    font-size: 10px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 6px;
  }

  /* ── Insights Panel ── */
  .insights-btn { display: none; }
  .insights-btn.visible { display: inline-block; }
  .insights-panel {
    position: fixed;
    top: 0; right: 0; bottom: 0;
    width: 560px;
    max-width: 100vw;
    background: var(--surface);
    border-left: 1px solid var(--border);
    z-index: 100;
    overflow-y: auto;
    animation: slideIn 0.35s var(--ease-out) both;
    box-shadow: -20px 0 60px rgba(0,0,0,0.4);
  }
  .insights-panel.hidden { display: none; }
  .insights-inner { padding: 32px 28px; }
  .insights-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--border);
  }
  .insights-title { font-family: var(--display); font-size: 22px; font-weight: 400; color: var(--text); }
  .insights-tabs {
    display: flex; gap: 0; margin-bottom: 24px;
    border: 1px solid var(--border); border-radius: 8px; overflow: hidden;
  }
  .insights-tab {
    flex: 1; font-family: var(--mono); font-size: 10px; padding: 8px 4px;
    background: transparent; border: none; border-right: 1px solid var(--border);
    color: var(--text-dim); cursor: pointer; text-align: center;
    transition: all 0.15s ease; letter-spacing: 0.03em; text-transform: uppercase;
  }
  .insights-tab:last-child { border-right: none; }
  .insights-tab:hover { color: var(--text-secondary); background: var(--surface-hover); }
  .insights-tab.active { color: var(--accent-text); background: var(--accent-soft); }
  .insights-content { min-height: 200px; }
  .insights-empty { text-align: center; padding: 48px 16px; color: var(--text-dim); font-size: 12px; }
  .insights-loading { text-align: center; padding: 48px 16px; color: var(--text-dim); font-size: 12px; }
  .spike-row { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border-subtle); }
  .spike-bar-wrap { width: 80px; height: 8px; background: var(--muted-soft); border-radius: 4px; overflow: hidden; flex-shrink: 0; }
  .spike-bar { height: 100%; border-radius: 4px; transition: width 0.3s var(--ease); }
  .spike-info { flex: 1; min-width: 0; }
  .spike-msg { font-size: 12px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .spike-meta { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
  .spike-zscore { font-size: 11px; font-weight: 600; color: var(--accent-text); flex-shrink: 0; width: 48px; text-align: right; }
  .mover-row { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border-subtle); }
  .mover-delta { font-size: 13px; font-weight: 600; width: 64px; text-align: right; flex-shrink: 0; }
  .mover-delta.up { color: var(--red-text); }
  .mover-delta.down { color: var(--green-text); }
  .mover-info { flex: 1; min-width: 0; }
  .mover-msg { font-size: 12px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .mover-counts { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
  .mover-pct { font-size: 10px; padding: 2px 6px; border-radius: 4px; flex-shrink: 0; }
  .mover-pct.up { background: var(--red-soft); color: var(--red-text); }
  .mover-pct.down { background: var(--green-soft); color: var(--green-text); }
  .corr-card { padding: 12px; margin-bottom: 8px; background: var(--surface-raised); border: 1px solid var(--border); border-radius: 8px; }
  .corr-pair { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .corr-fp { font-size: 11px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
  .corr-arrow { color: var(--text-dim); font-size: 10px; flex-shrink: 0; }
  .corr-score { font-size: 12px; font-weight: 600; color: var(--accent-text); text-align: right; }
  .release-card { padding: 14px; margin-bottom: 8px; background: var(--surface-raised); border: 1px solid var(--border); border-radius: 8px; }
  .release-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
  .release-name { font-size: 13px; font-weight: 600; color: var(--text); }
  .release-score { font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 4px; }
  .release-score.bad { background: var(--red-soft); color: var(--red-text); }
  .release-score.ok { background: var(--muted-soft); color: var(--text-secondary); }
  .release-score.good { background: var(--green-soft); color: var(--green-text); }
  .release-stats { display: flex; gap: 16px; font-size: 11px; color: var(--text-dim); }
  .release-stat-val { color: var(--text-secondary); font-weight: 500; }
  .env-table { width: 100%; border-collapse: collapse; font-size: 11px; }
  .env-table th { text-align: left; padding: 8px 6px; border-bottom: 1px solid var(--border); color: var(--text-dim); font-weight: 500; text-transform: uppercase; font-size: 10px; letter-spacing: 0.05em; }
  .env-table td { padding: 8px 6px; border-bottom: 1px solid var(--border-subtle); color: var(--text); }
  .env-pct-bar { width: 60px; height: 6px; background: var(--muted-soft); border-radius: 3px; overflow: hidden; display: inline-block; vertical-align: middle; margin-right: 6px; }
  .env-pct-fill { height: 100%; background: var(--accent); border-radius: 3px; }

  /* Page View System - Full Page Navigation */
  .page-view { 
    display: none; 
    min-height: calc(100vh - 64px);
    animation: fadeIn 0.3s var(--ease-out) both;
  }
  .page-view.active { display: block; }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Primary Navigation */
  .nav-primary {
    display: flex;
    gap: 4px;
    background: var(--surface-raised);
    padding: 4px;
    border-radius: 8px;
    border: 1px solid var(--border);
  }
  
  .nav-primary-btn {
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 600;
    padding: 8px 16px;
    background: transparent;
    border: none;
    border-radius: 6px;
    color: var(--text-dim);
    cursor: pointer;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    transition: all 0.15s ease;
  }
  
  .nav-primary-btn:hover {
    color: var(--text-secondary);
    background: var(--surface-hover);
  }
  
  .nav-primary-btn.active {
    color: var(--text);
    background: var(--accent-soft);
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }
  
  /* Secondary Navigation */
  .nav-secondary {
    display: flex;
    gap: 0;
    margin-bottom: 24px;
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  
  .nav-secondary::-webkit-scrollbar { display: none; }
  
  .nav-secondary-btn {
    flex: 1;
    min-width: 100px;
    font-family: var(--mono);
    font-size: 11px;
    padding: 10px 16px;
    background: transparent;
    border: none;
    border-right: 1px solid var(--border);
    color: var(--text-dim);
    cursor: pointer;
    text-align: center;
    transition: all 0.15s ease;
    white-space: nowrap;
  }
  
  .nav-secondary-btn:last-child { border-right: none; }
  .nav-secondary-btn:hover { color: var(--text-secondary); background: var(--surface-hover); }
  .nav-secondary-btn.active { color: var(--accent-text); background: var(--accent-soft); }
  
  /* LLM Page Specific Styles */
  .llm-dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  
  .llm-card {
    background: var(--surface-raised);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .llm-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }
  
  .llm-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }
  
  .llm-card-title {
    font-size: 11px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .llm-card-value {
    font-size: 28px;
    font-weight: 600;
    color: var(--text);
    font-family: var(--mono);
  }
  
  .llm-section { margin-bottom: 32px; }
  
  .llm-section-title {
    font-family: var(--display);
    font-size: 18px;
    color: var(--text);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }
  
  /* Mobile Bottom Navigation */
  @media (max-width: 768px) {
    .header { padding: 0 16px; }
    
    .nav-primary {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      border-radius: 0;
      border: none;
      border-top: 1px solid var(--border);
      background: var(--surface);
      padding: 8px;
      z-index: 100;
      justify-content: space-around;
    }
    
    .nav-primary-btn {
      flex: 1;
      padding: 8px 4px;
      font-size: 9px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    
    .nav-primary-btn::before {
      font-size: 18px;
      line-height: 1;
      margin-bottom: 2px;
    }
    
    .container { padding: 20px 16px 100px; max-width: 100%; }
    .page-view { padding: 0; }
    
    .nav-secondary {
      flex-wrap: nowrap;
      overflow-x: scroll;
      -webkit-overflow-scrolling: touch;
    }
    
    .nav-secondary-btn {
      min-width: auto;
      font-size: 10px;
      padding: 10px 12px;
    }
    
    .llm-dashboard-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .llm-card { padding: 16px; }
    .llm-card-value { font-size: 22px; }
    
    .insights-panel {
      width: 100vw;
      left: 0;
      right: auto;
      animation: slideUp 0.35s var(--ease-out) both;
      box-shadow: 0 -20px 60px rgba(0,0,0,0.4);
    }
    
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    
    .insights-inner { padding: 24px 16px 100px; }
    .insights-tabs { flex-wrap: nowrap; overflow-x: auto; }
    .insights-tab { min-width: 80px; padding: 10px 8px; }
  }
  
  /* Tablet adjustments */
  @media (min-width: 769px) and (max-width: 1024px) {
    .llm-dashboard-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

</style>
</head>
<body>
<div class="toast-container" id="toastContainer"></div>

<!-- Welcome Modal -->
<div class="modal-overlay hidden" id="welcomeModal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modalTitle">Welcome to Bloop</h2>
      <p id="modalSubtitle">Self-hosted error tracking, ready in 60 seconds.</p>
    </div>
    <div class="modal-steps">
      <div class="modal-step-dot active" id="dot0"></div>
      <div class="modal-step-dot" id="dot1"></div>
      <div class="modal-step-dot" id="dot2"></div>
    </div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-footer">
      <button class="btn-modal btn-modal-ghost" id="modalSkip" onclick="closeWelcome()">Skip</button>
      <button class="btn-modal btn-modal-primary" id="modalNext" onclick="nextWelcomeStep()">Get Started</button>
    </div>
  </div>
</div>


<header class="header">
  <div class="header-brand"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAACJCAYAAABpXHdXAAAAIGNIUk0AAHomAACAhAAA+gAAAIDoAAB1MAAA6mAAADqYAAAXcJy6UTwAAAAGYktHRAD/AP8A/6C9p5MAAAAHdElNRQfqAgwXFhUjMZpVAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDI2LTAyLTEyVDIyOjUyOjU4KzAwOjAwhUCZOQAAACV0RVh0ZGF0ZTptb2RpZnkAMjAyNi0wMi0xMlQxODo1NjoyOSswMDowMBd6wK8AAAAodEVYdGRhdGU6dGltZXN0YW1wADIwMjYtMDItMTJUMjM6MjI6MjArMDA6MDBuj4siAABaMklEQVR42uV9dZwcx5X/91V199DOsrRiMsgYMzPEFDM7dhIzhxy8JHeXXOAXuuRyAbMdcMiOk9iO7ZidGGJmBrFW0mp5qKGq3u+P7sHd0e5KK+3K9/VnremZxup69fg9+uQnPwUA+OlP/xe1+NQnPw0A4Og/APjZT39a+v3KKy+v2v9nP/sFNid86spPVmxx9Bfif3/28/U+7+VXXFG1/YufDz3X5ZddUr3P1ddukme+9LLLqravufpqAMAll15a9f2111wT7n/5pQAoGhoCmKv2q9y89trwXBdfWv1s111TfrZ615mssEbehQA2E32fGwVMFW+3mj4mLS6++KKq7euuu35sz2yGf5dcnOlUTQSGubzNQF8wiDanOTqm4niI0mfaDMZxtLB4HZPfsK772xWXXxHSDQG0GY7IJZdeWrMabn7PMBpceMEF5Q0CTJ3nLEoItRwCNdOjxW7ENddcXTrmkosvBRGDUJ4rxgQT/djjBssYVfdHZgMQAEP1pw8DzAQSm98ES0iJfFB8/vFjIcOJVJMFzGOTCJgjkiozkRIuueSi6Hy1v1Dd8wV+/UV3MsIiUHn1GDI64d/wv1cPws82QGafKAx4PgQRKHoUsWGnGxM2lc4xBEaBh5nAgRp+oWRwyFRq5sG5F1wArcM9ijj/vPMAAFoZcH0aqcJ555U53M033zgxY7IOWIbrr5rMQEhABrWr6weBjVoilLGLQ/Czqye3wgiMXeeoha5Z7T9x3rnr3N8YMzxjNQYaiBYXAtEoKWIzE2VHVNIN62jlqBmA0Y7HJMW111yDKy65eJNyjfHAJz7x8dJn5urp9ptf/3rI/jfcWL0q1yUIEymUNWDmsgJfJUVRxU2EVs5KGjF1jAElvZYZIAJN8jdg6XVwAq0ViAksOOIiFQ+q6suxl158QdX2NddNPtYJYIhCetlF55U+X339zRN9dxvnkSsmLhGVJjpXWqsqUJzoQ9QMADpQVZzDkiNP9irCYYYUk5xARmIFTBUryAcMPE7m6/PP+3jV9k03/3o9z7QJnrligjIAYYVChFmH+TfUQbiKfn5500342DnnVH13069/BQA455yz615fKR2dFwABapKL6iOLWOaD6QPZmDjvE9UEc/OvJg/B1Jp5f3PzLwEA53zsnOH319H7H2aNrLe+GFN/QS1ynJKENtEDMgKs6669oe6P1153HS664PyQydTw2Guv3zBlcTJgiHXOTH4T5K82kNgM87COPK4zqUtcdhhrZj3BYl0SB1f4SyY9dQCwzotMczffPLzMzbWa4CgwaXWOGoiKByvZ+zcRzjnztKrtW/5w26Z5ZmVgCKM2soTcgKMxqv5N66J4FBqOzzjt9PAYpQE5/AVYV7OdSa+kj7TDeMnpkxFV7k+i9da1anWOWhFrMkHXEZl93xv2e64JNakcIkLR0U4IbWCVsSfDm4drzcG/+93vJnpI1olRxGJ9cEEVb7v8sjcck0nnqAWPkU8aXRaJqIbtrEsgrSeyKaWwOeH/NAcRNeExV183eSf2eGF9jC4cudLNCBy26tx1RDjezIw+Vj3do/yco1txLj3vo1Xb19w8iVBzv5fW2mj4mLS6++OKq7euuu35sz2yGf5dcnOlUTQSGubzNQF8wiDanOTqm4niI0mfaDMZxtLB4HZPfsK772xWXXxHSDQG0GY7IJZdeWrMabn7PMBpceMEF5Q0CTJ3nLEoItRwCNdOjxW7ENddcXTrmkosvBRGDUJ4rxgQT/djjBssYVfdHZgMQAEP1pw8DzAQSm98ES0iJfFB8/vFjIcOJVJMFzGOTCJgjkiozkRIuueSi6Hy1v1Dd8wV+/UV3MsIiUHn1GDI64d/wv1cPws82QGafKAx4PgQRKHoUsWGnGxM2lc4xBEaBh5nAgRp+oWRwyFRq5sG5F1wArcM9ijj/vPMAAFoZcH0aqcJ555U53M033zgxY7IOWIbrr5rMQEhABrWr6weBjVoilLGLQ/Czqye3wgiMXeeoha5Z7T9x3rnr3N8YMzxjNQYaiBYXAtEoKWIzE2VHVNIN62jlqBmA0Y7HJMW111yDKy65eJNyjfHAJz7x8dJn5urp9ptf/3rI/jfcWL0q1yUIEymUNWDmsgJfJUVRxU2EVs5KGjF1jAElvZYZIAJN8jdg6XVwAq0ViAksOOIiFQ+q6suxl158QdX2NddNPtYJYIhCetlF55U+X339zRN9dxvnkSsmLhGVJjpXWqsqUJzoQ9QMADpQVZzDkiNP9irCYYYUk5xARmIFTBUryAcMPE7m6/PP+3jV9k03/3o9z7QJnrligjIAYYVChFmH+TfUQbiKfn5500342DnnVH13069/BQA455yz615fKR2dFwABapKL6iOLWOaD6QPZmDjvE9UEc/OvJg/B1Jp5f3PzLwEA53zsnOH319H7H2aNrLe+GFN/QS1ynJKENtEDMgKs6669oe6P1153HS664PyQydTw2Guv3zBlcTJgiHXOTH4T5K82kNgM87COPK4zqUtcdhhrZj3BYl0SB1f4SyY9dQCwzotMczffPLzMzbWa4CgwaXWOGoiKByvZ+zcRzjnztKrtW/5w26Z5ZmVgCKM2soTcgKMxqv5N66J4FBqOzzjt9PAYpQE5/AVYV7OdSa+kj7TDeMnpkxFV7k+i9da1anWOWhFrMkHXEZl93xv2e64JNakcIkLR0U4IbWCVsSfDm4drzcG/+93vJnpI1olRxGJ9cEEVb7v8sjcck0nnqAWPkU8aXRaJqIbtrEsgrSeyKaWwOeH/NAcRNeExV183eSf2eGF9jC4cudLNCBy26tx1RDjezIw+Vj3do/yco1txLj3vo1Xb19w8... (line truncated to 2000 chars)
  
  <!-- Primary Navigation -->
  <nav class="nav-primary" role="navigation" aria-label="Main navigation">
    <button class="nav-primary-btn active" data-page="errors" onclick="showPage('errors')" aria-current="page">Errors</button>
    <button class="nav-primary-btn" data-page="analytics" onclick="toggleInsights()">Analytics</button>
    <button class="nav-primary-btn" data-page="llm" onclick="showPage('llm')">LLM</button>
    <button class="nav-primary-btn" data-page="settings" onclick="toggleSettings()">Settings</button>
  </nav>
  
  <div class="header-actions">
    <span class="status-dot" id="healthDot"></span>
    <button class="logout-btn" onclick="doLogout()" aria-label="Logout">Logout</button>
  </div>
</header>

<!-- Settings Panel -->
<div id="settingsPanel" class="settings-panel hidden">
  <div class="settings-inner">
    <div class="settings-header">
      <h2 class="settings-title">Settings</h2>
      <button class="logout-btn" onclick="toggleSettings()">Close</button>
    </div>

    <div id="adminSection" class="hidden">
      <div class="settings-section">
        <h3 class="settings-section-title">Projects</h3>
        <div id="projectsList" class="settings-list"></div>
        <div style="display:flex;gap:8px;margin-top:10px;">
          <input type="text" id="newProjectName" placeholder="Project name" style="flex:1;font-family:var(--mono);font-size:12px;padding:6px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);">
          <input type="text" id="newProjectSlug" placeholder="slug" style="width:120px;font-family:var(--mono);font-size:12px;padding:6px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);">
          <button class="auth-btn settings-btn" onclick="createProject()">Create</button>
        </div>
      </div>

      <div class="settings-section">
        <h3 class="settings-section-title">Source Maps</h3>
        <div id="sourcemapsList" class="settings-list"></div>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;align-items:center;">
          <select id="smProjectSlug" style="font-family:var(--mono);font-size:12px;padding:6px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);"></select>
          <input type="text" id="smRelease" placeholder="Release (e.g. 1.0.0)" style="width:140px;font-family:var(--mono);font-size:12px;padding:6px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);">
          <input type="file" id="smFile" accept=".map,.js.map" style="font-family:var(--mono);font-size:11px;color:var(--text-dim);">
          <button class="auth-btn settings-btn" onclick="uploadSourceMap()">Upload</button>
        </div>
      </div>

      <div class="settings-section">
        <h3 class="settings-section-title">Alerts</h3>
        <div id="alertsList"></div>
        <div id="alertForm" class="alert-form" style="display:none;">
          <input type="text" id="newAlertName" placeholder="Alert name">
          <input type="text" id="newAlertDesc" placeholder="Description (optional)">
          <select id="newAlertType">
            <option value="new_issue">New Issue</option>
            <option value="threshold">Threshold</option>
          </select>
          <div id="thresholdFields" style="display:none;">
            <input type="number" id="newAlertThreshold" placeholder="Threshold count" style="width:100%;font-family:var(--mono);font-size:11px;padding:6px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);margin-bottom:8px;">
            <input type="number" id="newAlertWindow" placeholder="Window (seconds)" style="width:100%;font-family:var(--mono);font-size:11px;padding:6px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);">
          </div>
          <button class="auth-btn settings-btn" onclick="createAlert()">Create Alert</button>
        </div>
        <button class="auth-btn settings-btn" onclick="toggleAlertForm()" style="margin-top:8px;">+ New Alert</button>
      </div>

      <div class="settings-section">
        <h3 class="settings-section-title">API Tokens</h3>
        <div id="tokensList" class="settings-list"></div>
        <div id="tokenForm" style="display:none; margin-top:8px;">
          <input type="text" id="newTokenName" placeholder="Token name (e.g. CI Pipeline)" style="width:100%;font-family:var(--mono);font-size:11px;padding:6px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);margin-bottom:8px;">
          <select id="newTokenProject" style="width:100%;font-family:var(--mono);font-size:11px;padding:6px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);margin-bottom:8px;"></select>
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;">
            <label style="font-size:11px;color:var(--text-dim);display:flex;align-items:center;gap:4px;"><input type="checkbox" class="token-scope" value="errors:read" checked> errors:read</label>
            <label style="font-size:11px;color:var(--text-dim);display:flex;align-items:center;gap:4px;"><input type="checkbox" class="token-scope" value="errors:write"> errors:write</label>
            <label style="font-size:11px;color:var(--text-dim);display:flex;align-items:center;gap:4px;"><input type="checkbox" class="token-scope" value="alerts:read"> alerts:read</label>
            <label style="font-size:11px;color:var(--text-dim);display:flex;align-items:center;gap:4px;"><input type="checkbox" class="token-scope" value="alerts:write"> alerts:write</label>
            <label style="font-size:11px;color:var(--text-dim);display:flex;align-items:center;gap:4px;"><input type="checkbox" class="token-scope" value="sourcemaps:read"> sourcemaps:read</label>
            <label style="font-size:11px;color:var(--text-dim);display:flex;align-items:center;gap:4px;"><input type="checkbox" class="token-scope" value="sourcemaps:write"> sourcemaps:write</label>
          </div>
          <button class="auth-btn settings-btn" onclick="createToken()">Create Token</button>
        </div>
        <div id="newTokenResult" style="display:none;margin-top:8px;padding:12px;background:var(--surface);border:1px solid var(--accent);border-radius:6px;">
          <div style="font-size:11px;color:var(--accent-text);font-weight:600;margin-bottom:4px;">Token created — copy it now, it won't be shown again!</div>
          <div style="display:flex;gap:6px;align-items:center;">
            <code id="newTokenValue" style="flex:1;font-size:11px;padding:6px 8px;background:var(--bg);border-radius:4px;overflow-x:auto;white-space:nowrap;color:var(--text);"></code>
            <button class="auth-btn settings-btn" onclick="copyToken()" style="white-space:nowrap;">Copy</button>
          </div>
        </div>
        <button class="auth-btn settings-btn" onclick="toggleTokenForm()" style="margin-top:8px;">+ New API Token</button>
      </div>

      <div class="settings-section">
        <h3 class="settings-section-title">Data Retention</h3>
        <div id="retentionInfo" style="margin-bottom:10px;">
          <div id="retentionStats" style="font-size:11px;color:var(--text-dim);margin-bottom:8px;"></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px;">
            <label style="font-size:11px;color:var(--text-secondary);">Raw events (days):
              <input type="number" id="retRawDays" min="1" max="3650" style="width:60px;font-family:var(--mono);font-size:11px;padding:4px 6px;background:var(--surface);border:1px solid var(--border);border-radius:4px;color:var(--text);margin-left:4px;">
            </label>
            <label style="font-size:11px;color:var(--text-secondary);">Hourly counts (days):
              <input type="number" id="retHourlyDays" min="1" max="3650" style="width:60px;font-family:var(--mono);font-size:11px;padding:4px 6px;background:var(--surface);border:1px solid var(--border);border-radius:4px;color:var(--text);margin-left:4px;">
            </label>
            <button class="auth-btn settings-btn" onclick="saveRetention()">Save</button>
          </div>
          <div id="retentionPerProject" style="margin-bottom:8px;"></div>
          <div style="display:flex;gap:8px;align-items:center;">
            <select id="retProjectSelect" style="font-family:var(--mono);font-size:11px;padding:4px 8px;background:var(--surface);border:1px solid var(--border);border-radius:4px;color:var(--text);"></select>
            <input type="number" id="retProjectDays" min="0" max="3650" placeholder="days (0=global)" style="width:80px;font-family:var(--mono);font-size:11px;padding:4px 6px;background:var(--surface);border:1px solid var(--border);border-radius:4px;color:var(--text);">
            <button class="auth-btn settings-btn" onclick="saveProjectRetention()">Set Override</button>
          </div>
        </div>
        <button class="auth-btn settings-btn danger-btn" onclick="purgeNow()" style="margin-top:6px;">Purge Now</button>
      </div>

      <div class="settings-section">
        <h3 class="settings-section-title">Users</h3>
        <div id="usersList" class="settings-list"></div>
      </div>

      <div class="settings-section">
        <h3 class="settings-section-title">Invites</h3>
        <button class="auth-btn settings-btn" onclick="createInvite()">Create Invite Link</button>
        <div id="inviteResult" class="invite-result hidden"></div>
        <div id="invitesList" class="settings-list"></div>
      </div>

      <div class="settings-section danger-zone">
        <h3 class="settings-section-title" style="color: var(--red-text);">Danger Zone</h3>
        <button class="auth-btn settings-btn danger-btn" onclick="confirmReset()">Reset All Access</button>
      </div>
    </div>

    <div id="nonAdminMsg" class="hidden">
      <p class="settings-note">Admin features are not available for your account.</p>
    </div>
  </div>
</div>

<!-- Insights Panel -->
<div id="insightsPanel" class="insights-panel hidden">
  <div class="insights-inner">
    <div class="insights-header">
      <h2 class="insights-title">Insights</h2>
      <button class="logout-btn" onclick="toggleInsights()">Close</button>
    </div>
    <div class="insights-tabs">
      <button class="insights-tab active" onclick="switchInsightsTab('spikes')">Spikes</button>
      <button class="insights-tab" onclick="switchInsightsTab('movers')">Movers</button>
      <button class="insights-tab" onclick="switchInsightsTab('correlations')">Corr</button>
      <button class="insights-tab" onclick="switchInsightsTab('releases')">Releases</button>
      <button class="insights-tab" onclick="switchInsightsTab('environments')">Envs</button>
    </div>
    <div class="insights-content" id="insightsContent">
      <div class="insights-empty">Select a tab to view analytics</div>
    </div>
  </div>
</div>

<!-- LLM Tracing Full Page -->
<div id="llmPage" class="page-view">
  <div class="container">
    <div class="llm-section">
      <h2 class="llm-section-title">LLM Observability</h2>
      
      <!-- Secondary Navigation -->
      <nav class="nav-secondary" role="navigation" aria-label="LLM sections">
        <button class="nav-secondary-btn active" data-llm-tab="overview" onclick="switchLlmTab('overview')">Overview</button>
        <button class="nav-secondary-btn" data-llm-tab="traces" onclick="switchLlmTab('traces')">Traces</button>
        <button class="nav-secondary-btn" data-llm-tab="models" onclick="switchLlmTab('models')">Models</button>
        <button class="nav-secondary-btn" data-llm-tab="prompts" onclick="switchLlmTab('prompts')">Prompts</button>
        <button class="nav-secondary-btn" data-llm-tab="experiments" onclick="switchLlmTab('experiments')">Experiments</button>
        <button class="nav-secondary-btn" data-llm-tab="scores" onclick="switchLlmTab('scores')">Scores</button>
        <button class="nav-secondary-btn" data-llm-tab="rag" onclick="switchLlmTab('rag')">RAG</button>
      </nav>
      
      <!-- LLM Content Area -->
      <div id="llmContent">
        <div class="insights-empty">Loading LLM data...</div>
      </div>
    </div>
  </div>
</div>

<!-- Errors Page (Default) -->
<div id="errorsPage" class="page-view active">
  <div class="container">
    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="statTotal">&mdash;</div>
        <div class="stat-label">Total Errors</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="statUnresolved">&mdash;</div>
        <div class="stat-label">Unresolved</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="statEvents24h">&mdash;</div>
        <div class="stat-label">Events 24h</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="statBuffer">&mdash;</div>
        <div class="stat-label">Buffer</div>
      </div>
    </div>

    <div class="trend-section" id="trendSection">
      <div class="trend-header">Event Volume — 72h</div>
      <div class="trend-chart" id="trendChart"></div>
    </div>

  <div class="detail-panel" id="detailPanel">
    <div class="detail-back" id="backBtn">&larr; Back to errors</div>
    <h2 class="detail-title" id="detailTitle"></h2>
    <div class="detail-actions">
      <button class="btn-resolve" id="resolveBtn">Resolve</button>
      <button class="btn-ignore" id="ignoreBtn">Ignore</button>
      <button class="btn-ignore" id="muteBtn">Mute</button>
      <button class="btn-resolve" id="unresolveBtn">Unresolve</button>
    </div>
    <div class="detail-agg" id="detailAggregates"></div>
    <div id="detailSamples"></div>
    <div id="detailHistory" class="status-timeline"></div>
  </div>

  <div class="filters" id="filtersBar">
    <select id="filterProject">
      <option value="">All projects</option>
    </select>
    <select id="filterStatus">
      <option value="">All statuses</option>
      <option value="unresolved" selected>Unresolved</option>
      <option value="resolved">Resolved</option>
      <option value="ignored">Ignored</option>
    </select>
    <input type="text" id="filterRelease" placeholder="Release...">
    <input type="text" id="filterRoute" placeholder="Route...">
    <select id="filterSort">
      <option value="last_seen">Last seen</option>
      <option value="total_count">Count</option>
      <option value="first_seen">First seen</option>
    </select>
    <button class="filter-btn" id="filterBtn">Apply</button>
  </div>

  <div id="errorList"><div class="loading">Loading...</div></div>
  </div>
</div>

<script>
const API = window.location.origin;
let currentFingerprint = null;
let projects = [];

function toast(message, type = 'info', duration = 4000) {
  const container = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = 'toast toast-' + type;
  t.textContent = message;
  container.appendChild(t);
  setTimeout(() => {
    t.classList.add('toast-exit');
    t.addEventListener('animationend', () => t.remove());
  }, duration);
}

function clearInputError(input) {
  input.classList.remove('input-error');
  const msg = input.parentElement.querySelector('.form-error-msg');
  if (msg) msg.remove();
}

function showInputError(input, message) {
  input.classList.add('input-error');
  const existing = input.parentElement.querySelector('.form-error-msg');
  if (existing) existing.textContent = message;
  else {
    const msg = document.createElement('div');
    msg.className = 'form-error-msg';
    msg.textContent = message;
    input.insertAdjacentElement('afterend', msg);
  }
}

// Clear validation on input
document.addEventListener('input', function(e) {
  if (e.target.classList.contains('input-error')) clearInputError(e.target);
});

function getSelectedProjectId() {
  return document.getElementById('filterProject').value || '';
}

function projectParam() {
  const pid = getSelectedProjectId();
  return pid ? 'project_id=' + encodeURIComponent(pid) : '';
}

async function loadProjects() {
  try {
    const r = await authFetch(API + '/v1/projects');
    if (!r || !r.ok) return;
    projects = await r.json();
    const sel = document.getElementById('filterProject');
    // Keep "All projects" option, clear rest
    while (sel.options.length > 1) sel.remove(1);
    projects.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.name;
      sel.appendChild(opt);
    });
  } catch {}
}

async function loadProjectsSettings() {
  const list = document.getElementById('projectsList');
  if (!list) return;
  try {
    const r = await authFetch(API + '/v1/projects');
    if (!r || !r.ok) return;
    const projs = await r.json();
    window._projects = projs;
    list.replaceChildren();
    projs.forEach(p => {
      const keyCode = el('code', { style: 'font-size:11px;color:var(--text-dim);background:var(--bg);padding:3px 8px;border-radius:4px;border:1px solid var(--border);flex:1;' }, 'bloop_\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022');
      const rotateBtn = el('button', { className: 'btn-modal-ghost', style: 'font-size:10px;padding:3px 10px;white-space:nowrap;', onclick: async function() {
        if (!confirm('Rotate API key for "' + p.name + '"? The old key will stop working immediately.')) return;
        try {
          const r = await authFetch(API + '/v1/projects/' + encodeURIComponent(p.slug) + '/rotate-key', { method: 'POST' });
          if (r && r.ok) {
            const proj = await r.json();
            keyCode.textContent = proj.api_key;
            keyCode.style.color = 'var(--accent-text)';
            keyCode.style.cursor = 'pointer';
            keyCode.title = 'Click to copy';
            keyCode.onclick = function() { navigator.clipboard.writeText(proj.api_key); this.textContent = 'Copied!'; this.style.color = 'var(--green-text)'; setTimeout(() => { this.textContent = proj.api_key; this.style.color = 'var(--accent-text)'; }, 1500); };
            // Update snippet tabs with new key
            const sc = keyCode.closest('.settings-item').querySelector('.snippet-wrap');
            if (sc) { sc.replaceChildren(); sc.appendChild(buildSnippetTabsDOM(proj.api_key)); const ft = sc.querySelector('.snippet-tab'); if (ft) ft.click(); }
            toast('Key rotated — copy it now, it won\'t be shown again', 'success');
          } else { toast('Failed to rotate key', 'error'); }
        } catch (e) { toast('Error: ' + e.message, 'error'); }
      } }, 'Rotate Key');
      const keyRow = el('div', { style: 'display:flex;align-items:center;gap:6px;margin-top:6px;' }, [
        el('span', { style: 'font-size:10px;color:var(--text-dim);white-space:nowrap;' }, 'API Key:'),
        keyCode,
        rotateBtn,
      ]);
      const snippetBtn = el('button', { className: 'btn-modal-ghost', style: 'font-size:10px;padding:3px 10px;margin-top:6px;', onclick: function() {
        const container = this.nextElementSibling;
        container.style.display = container.style.display === 'none' ? 'block' : 'none';
      } }, 'Show SDK Snippets');
      const snippetContainer = el('div', { className: 'snippet-wrap', style: 'display:none;margin-top:8px;' });
      snippetContainer.appendChild(buildSnippetTabsDOM('your-api-key'));
      const item = el('div', { className: 'settings-item', style: 'flex-direction:column;align-items:stretch;' }, [
        el('div', { style: 'display:flex;align-items:center;justify-content:space-between;' }, [
          el('div', null, [
            el('span', { className: 'name' }, p.name),
            el('span', { className: 'badge badge-active', style: 'margin-left:6px;' }, p.slug),
          ]),
          p.slug !== 'default' ? el('button', { className: 'remove-btn', onclick: () => deleteProject(p.slug) }, 'Delete') : null,
        ]),
        keyRow,
        snippetBtn,
        snippetContainer,
      ]);
      list.appendChild(item);
      setTimeout(() => {
        const firstTab = snippetContainer.querySelector('.snippet-tab');
        if (firstTab) firstTab.click();
      }, 0);
    });
  } catch {}
}

async function createProject() {
  const nameInput = document.getElementById('newProjectName');
  const slugInput = document.getElementById('newProjectSlug');
  const name = nameInput.value.trim();
  const slug = slugInput.value.trim();
  clearInputError(nameInput);
  clearInputError(slugInput);
  let hasError = false;
  if (!name) { showInputError(nameInput, 'Project name is required'); hasError = true; }
  if (!slug) { showInputError(slugInput, 'Slug is required'); hasError = true; }
  else if (!/^[a-z0-9-]+$/.test(slug)) { showInputError(slugInput, 'Lowercase letters, numbers, and hyphens only'); hasError = true; }
  if (hasError) return;
  try {
    const r = await authFetch(API + '/v1/projects', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, slug }),
    });
    if (r && r.ok) {
      const proj = await r.json();
      nameInput.value = '';
      slugInput.value = '';
      if (proj.api_key) {
        toast('Project created — API key: ' + proj.api_key + ' (copy now, won\'t be shown again)', 'success', 10000);
        navigator.clipboard.writeText(proj.api_key);
      } else {
        toast('Project "' + name + '" created', 'success');
      }
      loadProjectsSettings();
      loadProjects();
    } else if (r) {
      const err = await r.text();
      toast(err || 'Failed to create project', 'error');
    }
  } catch (e) {
    toast('Network error creating project', 'error');
  }
}

async function deleteProject(slug) {
  if (!confirm('Delete project "' + slug + '"? This cannot be undone.')) return;
  try {
    const r = await authFetch(API + '/v1/projects/' + encodeURIComponent(slug), { method: 'DELETE' });
    if (r && r.ok) {
      toast('Project "' + slug + '" deleted', 'success');
      loadProjectsSettings();
      loadProjects();
    } else if (r) {
      const err = await r.text();
      toast(err || 'Failed to delete project', 'error');
    }
  } catch (e) {
    toast('Network error deleting project', 'error');
  }
}

function timeAgo(ms) {
  const secs = Math.floor((Date.now() - ms) / 1000);
  if (secs < 60) return secs + 's ago';
  if (secs < 3600) return Math.floor(secs / 60) + 'm ago';
  if (secs < 86400) return Math.floor(secs / 3600) + 'h ago';
  return Math.floor(secs / 86400) + 'd ago';
}

// Safe DOM helpers - all user content goes through textContent, never innerHTML
function el(tag, attrs, children) {
  const e = document.createElement(tag);
  if (attrs) Object.entries(attrs).forEach(([k, v]) => {
    if (k === 'className') e.className = v;
    else if (k === 'onclick') e.addEventListener('click', v);
    else if (k === 'style') { if (typeof v === 'string') e.setAttribute('style', v); else Object.assign(e.style, v); }
    else e.setAttribute(k, v);
  });
  if (children) {
    if (typeof children === 'string') e.textContent = children;
    else if (Array.isArray(children)) children.forEach(c => { if (c) e.appendChild(c); });
    else e.appendChild(children);
  }
  return e;
}

function span(text, className) {
  return el('span', className ? { className } : null, text);
}

async function loadHealth() {
  try {
    const r = await fetch(API + '/health');
    const d = await r.json();
    document.getElementById('healthDot').className = 'status-dot ' + (d.status === 'ok' ? 'ok' : 'err');
    document.getElementById('healthText').textContent = d.status;
    document.getElementById('statBuffer').textContent = (d.buffer_usage * 100).toFixed(1) + '%';
  } catch { }
}

async function loadStats() {
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/stats' + (pp ? '?' + pp : ''));
    if (!r) return;
    const d = await r.json();
    document.getElementById('statTotal').textContent = d.total_errors.toLocaleString();
    document.getElementById('statUnresolved').textContent = d.unresolved_errors.toLocaleString();
    document.getElementById('statEvents24h').textContent = d.total_events_24h.toLocaleString();
    return d;
  } catch { }
}

async function loadErrors() {
  const params = new URLSearchParams();
  const pid = getSelectedProjectId();
  const status = document.getElementById('filterStatus').value;
  const release = document.getElementById('filterRelease').value;
  const route = document.getElementById('filterRoute').value;
  const sort = document.getElementById('filterSort').value;
  if (pid) params.set('project_id', pid);
  if (status) params.set('status', status);
  if (release) params.set('release', release);
  if (route) params.set('route', route);
  if (sort) params.set('sort', sort);

  const container = document.getElementById('errorList');
  try {
    const r = await authFetch(API + '/v1/errors?' + params.toString());
    if (!r) return;
    const errors = await r.json();
    container.replaceChildren();

    if (errors.length === 0) {
      const emptyState = el('div', { className: 'empty-state' }, [
        el('div', { className: 'empty-state-icon' }, '\u{1F41B}'),
        el('h3', null, 'No errors yet'),
        el('p', null, 'Set up an SDK to start capturing errors from your apps. It only takes a minute.'),
        el('div', null, [
          el('button', { className: 'btn-empty', onclick: showWelcome }, 'Set Up Integration'),
          el('button', { className: 'btn-empty-ghost', onclick: () => window.open('docs.html', '_blank') }, 'Read Docs'),
        ]),
      ]);
      container.appendChild(emptyState);
      if (!hadEventsOnLoad) startFirstEventPolling();
      return;
    }

    const list = el('div', { className: 'error-list' });
    errors.forEach(e => {
      const metaItems = [span(e.source), span(e.release), span(e.environment)];
      if (e.route_or_procedure) metaItems.push(span(e.route_or_procedure));

      const row = el('div', { className: 'error-row', onclick: () => openDetail(e.fingerprint) }, [
        el('div', { className: 'main' }, [
          el('div', { className: 'type-line' }, [
            el('span', { className: 'type' }, e.error_type),
            span(e.status, 'badge ' + e.status),
          ]),
          el('div', { className: 'message' }, e.message),
          el('div', { className: 'meta' }, metaItems),
        ]),
        el('div', { className: 'right' }, [
          el('div', { className: 'count' }, e.total_count.toLocaleString()),
          el('div', { className: 'time' }, timeAgo(e.last_seen)),
        ]),
      ]);
      list.appendChild(row);
      // Load sparkline asynchronously
      loadSparklineForFp(e.fingerprint).then(data => {
        if (data.length > 0) {
          const rightDiv = row.querySelector('.right');
          if (rightDiv) rightDiv.appendChild(buildSparkline(data, 60, 16));
        }
      });
    });
    container.appendChild(list);
  } catch {
    container.replaceChildren(el('div', { className: 'empty' }, 'Failed to load errors'));
  }
}

async function openDetail(fp) {
  currentFingerprint = fp;
  document.getElementById('filtersBar').style.display = 'none';
  document.getElementById('errorList').style.display = 'none';
  document.getElementById('trendSection').style.display = 'none';
  const panel = document.getElementById('detailPanel');
  panel.classList.add('active');

  try {
    const r = await authFetch(API + '/v1/errors/' + encodeURIComponent(fp));
    if (!r) return;
    const d = await r.json();
    const agg = d.aggregates[0];
    document.getElementById('detailTitle').textContent = agg.error_type + ': ' + agg.message;

    const aggContainer = document.getElementById('detailAggregates');
    aggContainer.replaceChildren();
    d.aggregates.forEach(a => {
      const info = el('div', { className: 'detail-agg-item' }, [
        el('strong', null, a.release),
        document.createTextNode(' / ' + a.environment + ' \u2014 ' +
          a.total_count.toLocaleString() + ' events, ' + a.status +
          ', first ' + timeAgo(a.first_seen) + ', last ' + timeAgo(a.last_seen)),
      ]);
      aggContainer.appendChild(info);
    });

    const samplesContainer = document.getElementById('detailSamples');
    samplesContainer.replaceChildren();
    samplesContainer.appendChild(el('div', { className: 'samples-heading' }, 'Samples'));
    d.samples.forEach(s => {
      const metaItems = [span(s.source), span(s.release), span(timeAgo(s.captured_at))];
      if (s.request_id) metaItems.push(span('req: ' + s.request_id));

      const children = [el('div', { className: 'sample-meta' }, metaItems)];
      if (s.deobfuscated_stack && s.deobfuscated_stack.length > 0) {
        // Show toggle for raw/deobfuscated
        const stackId = 'stack-' + Math.random().toString(36).substr(2, 9);
        const toggleBar = el('div', { style: 'display:flex;gap:8px;margin:4px 0;' }, [
          el('button', { className: 'stack-toggle active', id: stackId + '-deob-btn', onclick: function() {
            document.getElementById(stackId + '-deob').style.display = 'block';
            document.getElementById(stackId + '-raw').style.display = 'none';
            this.classList.add('active');
            document.getElementById(stackId + '-raw-btn').classList.remove('active');
          }}, 'Original'),
          el('button', { className: 'stack-toggle', id: stackId + '-raw-btn', onclick: function() {
            document.getElementById(stackId + '-raw').style.display = 'block';
            document.getElementById(stackId + '-deob').style.display = 'none';
            this.classList.add('active');
            document.getElementById(stackId + '-deob-btn').classList.remove('active');
          }}, 'Raw'),
        ]);
        children.push(toggleBar);
        // Deobfuscated view
        const deobLines = s.deobfuscated_stack.map(f => {
          if (f.original_file) {
            const name = f.original_name ? f.original_name + ' ' : '';
            return '  at ' + name + '(' + f.original_file + ':' + f.original_line + ':' + f.original_column + ')';
          }
          return f.raw_frame;
        }).join('\n');
        children.push(el('pre', { id: stackId + '-deob', style: 'display:block;' }, deobLines));
        children.push(el('pre', { id: stackId + '-raw', style: 'display:none;' }, s.stack));
      } else if (s.stack) {
        children.push(el('pre', null, s.stack));
      }
      if (s.metadata) children.push(el('pre', null, JSON.stringify(s.metadata, null, 2)));

      samplesContainer.appendChild(el('div', { className: 'sample' }, children));
    });
    // Load status history
    loadHistory(fp);
  } catch {
    document.getElementById('detailSamples').replaceChildren(
      el('div', { className: 'empty' }, 'Failed to load detail')
    );
  }
}

function closeDetail() {
  currentFingerprint = null;
  document.getElementById('detailPanel').classList.remove('active');
  document.getElementById('filtersBar').style.display = 'flex';
  document.getElementById('errorList').style.display = 'block';
  document.getElementById('trendSection').style.display = 'block';
}

async function authFetch(url, opts) {
  const r = await fetch(url, opts);
  if (r.status === 401) { window.location.href = '/auth/login'; return null; }
  return r;
}

async function resolveError() {
  if (!currentFingerprint) return;
  const pp = projectParam();
  await authFetch(API + '/v1/errors/' + encodeURIComponent(currentFingerprint) + '/resolve' + (pp ? '?' + pp : ''), { method: 'POST' });
  closeDetail(); loadErrors(); loadStats();
}

async function ignoreError() {
  if (!currentFingerprint) return;
  const pp = projectParam();
  await authFetch(API + '/v1/errors/' + encodeURIComponent(currentFingerprint) + '/ignore' + (pp ? '?' + pp : ''), { method: 'POST' });
  closeDetail(); loadErrors(); loadStats();
}

// ── SVG chart helpers ──
function buildAreaChart(data, width, height, color) {
  if (!data.length) return null;
  const max = Math.max(...data.map(d => d.count), 1);
  const step = width / Math.max(data.length - 1, 1);
  const points = data.map((d, i) => [i * step, height - (d.count / max) * (height - 8)]);
  const lineD = 'M' + points.map(p => p.join(',')).join('L');
  const areaD = lineD + 'L' + (width) + ',' + height + 'L0,' + height + 'Z';

  const ns = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(ns, 'svg');
  svg.setAttribute('viewBox', '0 0 ' + width + ' ' + height);
  svg.setAttribute('preserveAspectRatio', 'none');

  const area = document.createElementNS(ns, 'path');
  area.setAttribute('d', areaD);
  area.setAttribute('fill', color);
  area.setAttribute('opacity', '0.15');
  svg.appendChild(area);

  const line = document.createElementNS(ns, 'path');
  line.setAttribute('d', lineD);
  line.setAttribute('fill', 'none');
  line.setAttribute('stroke', color);
  line.setAttribute('stroke-width', '1.5');
  svg.appendChild(line);

  return svg;
}

function buildSparkline(data, w, h) {
  if (!data.length) return document.createTextNode('');
  const color = 'var(--accent)';
  const max = Math.max(...data.map(d => d.count), 1);
  const step = w / Math.max(data.length - 1, 1);
  const ns = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(ns, 'svg');
  svg.setAttribute('width', w);
  svg.setAttribute('height', h);
  svg.setAttribute('viewBox', '0 0 ' + w + ' ' + h);

  const points = data.map((d, i) => [i * step, h - 1 - (d.count / max) * (h - 2)]);
  const d = 'M' + points.map(p => p.join(',')).join('L');
  const path = document.createElementNS(ns, 'path');
  path.setAttribute('d', d);
  path.setAttribute('fill', 'none');
  path.setAttribute('stroke', color);
  path.setAttribute('stroke-width', '1.2');
  svg.appendChild(path);

  const container = el('span', { className: 'sparkline' });
  container.appendChild(svg);
  return container;
}

async function loadTrend() {
  const chart = document.getElementById('trendChart');
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/trends?hours=72' + (pp ? '&' + pp : ''));
    if (!r || !r.ok) return;
    const data = await r.json();
    chart.replaceChildren();
    if (data.length === 0) {
      chart.appendChild(el('div', { className: 'empty-state', style: { padding: '24px' } }, [
        el('p', { style: { color: 'var(--text-dim)', fontSize: '12px', margin: 0 } }, 'Trend data will appear here once errors are captured.'),
      ]));
      return;
    }
    const svg = buildAreaChart(data, 800, 120, '#E8736C');
    if (svg) chart.appendChild(svg);
  } catch {
    chart.replaceChildren(el('div', { className: 'empty', style: { padding: '24px' } }, 'Failed to load trend'));
  }
}

async function loadSparklineForFp(fp) {
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/errors/' + encodeURIComponent(fp) + '/trend?hours=24' + (pp ? '&' + pp : ''));
    if (!r || !r.ok) return [];
    return await r.json();
  } catch { return []; }
}

async function loadHistory(fp) {
  const container = document.getElementById('detailHistory');
  container.replaceChildren();
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/errors/' + encodeURIComponent(fp) + '/history' + (pp ? '?' + pp : ''));
    if (!r || !r.ok) return;
    const entries = await r.json();
    if (entries.length === 0) return;
    container.appendChild(el('div', { className: 'samples-heading' }, 'Status History'));
    entries.forEach(e => {
      container.appendChild(el('div', { className: 'timeline-entry' }, [
        el('span', { className: 'timeline-time' }, timeAgo(e.changed_at)),
        document.createTextNode(e.old_status + ' \u2192 ' + e.new_status),
      ]));
    });
  } catch {}
}

async function muteError() {
  if (!currentFingerprint) return;
  const pp = projectParam();
  await authFetch(API + '/v1/errors/' + encodeURIComponent(currentFingerprint) + '/mute' + (pp ? '?' + pp : ''), { method: 'POST' });
  closeDetail(); loadErrors(); loadStats();
}

async function unresolveError() {
  if (!currentFingerprint) return;
  const pp = projectParam();
  await authFetch(API + '/v1/errors/' + encodeURIComponent(currentFingerprint) + '/unresolve' + (pp ? '?' + pp : ''), { method: 'POST' });
  closeDetail(); loadErrors(); loadStats();
}

// Wire up
document.getElementById('backBtn').addEventListener('click', closeDetail);
document.getElementById('resolveBtn').addEventListener('click', resolveError);
document.getElementById('ignoreBtn').addEventListener('click', ignoreError);
document.getElementById('muteBtn').addEventListener('click', muteError);
document.getElementById('unresolveBtn').addEventListener('click', unresolveError);
document.getElementById('filterBtn').addEventListener('click', loadErrors);
document.addEventListener('keydown', e => { if (e.key === 'Escape' && currentFingerprint) closeDetail(); });

async function doLogout() {
  await fetch(API + '/auth/logout', { method: 'POST' });
  window.location.href = '/auth/login';
}

// ── Settings ──
let settingsOpen = false;

function toggleSettings() {
  settingsOpen = !settingsOpen;
  const panel = document.getElementById('settingsPanel');
  if (settingsOpen) {
    panel.classList.remove('hidden');
    loadAdminData();
    loadProjectsSettings();
    loadAlerts();
    loadSourceMaps();
    loadTokens();
    loadRetention();
  } else {
    panel.classList.add('hidden');
  }
}

async function loadAdminData() {
  const r = await authFetch(API + '/v1/admin/users');
  if (!r) return;
  if (r.status === 403) {
    document.getElementById('adminSection').classList.add('hidden');
    document.getElementById('nonAdminMsg').classList.remove('hidden');
    return;
  }
  document.getElementById('adminSection').classList.remove('hidden');
  document.getElementById('nonAdminMsg').classList.add('hidden');

  const users = await r.json();
  const list = document.getElementById('usersList');
  list.replaceChildren();
  users.forEach(u => {
    const actions = el('div', { style: { display: 'flex', gap: '6px', alignItems: 'center' } });
    if (u.is_admin) {
      actions.appendChild(el('button', { className: 'remove-btn', style: { fontSize: '10px', padding: '3px 8px' }, onclick: () => updateUserRole(u.id, u.username, false) }, 'Demote'));
    } else {
      actions.appendChild(el('button', { className: 'auth-btn settings-btn', style: { fontSize: '10px', padding: '3px 8px' }, onclick: () => updateUserRole(u.id, u.username, true) }, 'Make Admin'));
      actions.appendChild(el('button', { className: 'remove-btn', onclick: () => removeUser(u.id, u.username) }, 'Remove'));
    }
    const item = el('div', { className: 'settings-item' }, [
      el('div', null, [
        el('span', { className: 'name' }, u.username),
        u.is_admin ? el('span', { className: 'badge badge-admin' }, 'admin') : null,
      ]),
      actions,
    ]);
    list.appendChild(item);
  });

  // Load invites
  const ir = await authFetch(API + '/v1/admin/invites');
  if (!ir || !ir.ok) return;
  const invites = await ir.json();
  const ilist = document.getElementById('invitesList');
  ilist.replaceChildren();
  invites.forEach(inv => {
    const isExpired = inv.expires_at * 1000 < Date.now();
    const statusText = inv.used ? 'used' : (isExpired ? 'expired' : 'active');
    const badgeClass = inv.used ? 'badge-used' : (isExpired ? 'badge-used' : 'badge-active');
    const item = el('div', { className: 'settings-item' }, [
      el('div', null, [
        el('span', { className: 'name' }, inv.token.substring(0, 12) + '...'),
        el('span', { className: 'badge ' + badgeClass }, statusText),
      ]),
    ]);
    ilist.appendChild(item);
  });
}

async function removeUser(userId, username) {
  if (!confirm('Remove user "' + username + '"? They will no longer be able to sign in.')) return;
  const r = await authFetch(API + '/v1/admin/users/' + encodeURIComponent(userId), { method: 'DELETE' });
  if (r && r.ok) loadAdminData();
}

async function updateUserRole(userId, username, isAdmin) {
  const action = isAdmin ? 'promote' : 'demote';
  if (!confirm(isAdmin ? 'Make "' + username + '" an admin?' : 'Remove admin privileges from "' + username + '"?')) return;
  const r = await authFetch(API + '/v1/admin/users/' + encodeURIComponent(userId) + '/role', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ is_admin: isAdmin }),
  });
  if (r && r.ok) {
    toast('User ' + action + 'd', 'success');
    loadAdminData();
  } else if (r) {
    const data = await r.json().catch(() => ({}));
    toast(data.error || 'Failed to ' + action, 'error');
  }
}

async function createInvite() {
  const r = await authFetch(API + '/v1/admin/invites', { method: 'POST' });
  if (!r || !r.ok) return;
  const data = await r.json();
  const url = window.location.origin + '/auth/login?invite=' + data.token;
  const result = document.getElementById('inviteResult');
  result.textContent = url;
  result.classList.remove('hidden');
  result.onclick = () => {
    navigator.clipboard.writeText(url);
    result.textContent = 'Copied!';
    setTimeout(() => { result.textContent = url; }, 1500);
  };
  loadAdminData();
}

function confirmReset() {
  if (!confirm('This will delete ALL users, sessions, and credentials. You will need to re-register. Continue?')) return;
  if (!confirm('Are you absolutely sure? This cannot be undone.')) return;
  doReset();
}

async function doReset() {
  const r = await authFetch(API + '/v1/admin/reset', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ confirm: true }),
  });
  if (r && r.ok) {
    window.location.href = '/auth/login';
  }
}

// ── Retention ──

async function loadRetention() {
  try {
    const r = await authFetch(API + '/v1/admin/retention');
    if (!r || !r.ok) return;
    const data = await r.json();

    document.getElementById('retRawDays').value = data.global.raw_events_days;
    document.getElementById('retHourlyDays').value = data.global.hourly_counts_days;

    const sizeKB = Math.round(data.storage.db_size_bytes / 1024);
    const sizeMB = (sizeKB / 1024).toFixed(1);
    const sizeStr = sizeKB > 1024 ? sizeMB + ' MB' : sizeKB + ' KB';
    document.getElementById('retentionStats').textContent =
      'DB size: ' + sizeStr +
      ' | Raw events: ' + data.storage.raw_events_count.toLocaleString() +
      ' | Hourly counts: ' + data.storage.hourly_counts_count.toLocaleString();

    const ppDiv = document.getElementById('retentionPerProject');
    ppDiv.replaceChildren();
    data.per_project.forEach(pp => {
      const ppEl = el('div', { style: { fontSize: '11px', color: 'var(--text-secondary)', marginBottom: '4px' } }, [
        span(pp.project_name + ': ' + pp.raw_events_days + ' days'),
        el('button', { className: 'remove-btn', style: { fontSize: '9px', padding: '2px 6px', marginLeft: '6px' },
          onclick: () => removeProjectRetention(pp.project_id) }, 'x'),
      ]);
      ppDiv.appendChild(ppEl);
    });

    // Populate project dropdown
    const sel = document.getElementById('retProjectSelect');
    sel.replaceChildren();
    (window._projects || []).forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.name;
      sel.appendChild(opt);
    });
  } catch {}
}

async function saveRetention() {
  const rawDays = parseInt(document.getElementById('retRawDays').value);
  const hourlyDays = parseInt(document.getElementById('retHourlyDays').value);
  if (!rawDays || rawDays < 1) return;
  if (!hourlyDays || hourlyDays < 1) return;
  const r = await authFetch(API + '/v1/admin/retention', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ raw_events_days: rawDays, hourly_counts_days: hourlyDays }),
  });
  if (r && r.ok) {
    toast('Retention settings saved', 'success');
    loadRetention();
  }
}

async function saveProjectRetention() {
  const projectId = document.getElementById('retProjectSelect').value;
  const days = parseInt(document.getElementById('retProjectDays').value);
  if (!projectId) return;
  if (isNaN(days) || days < 0) return;
  const r = await authFetch(API + '/v1/admin/retention', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ per_project: [{ project_id: projectId, raw_events_days: days }] }),
  });
  if (r && r.ok) {
    toast(days === 0 ? 'Override removed' : 'Project retention set to ' + days + ' days', 'success');
    document.getElementById('retProjectDays').value = '';
    loadRetention();
  }
}

async function removeProjectRetention(projectId) {
  const r = await authFetch(API + '/v1/admin/retention', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ per_project: [{ project_id: projectId, raw_events_days: 0 }] }),
  });
  if (r && r.ok) {
    toast('Override removed', 'success');
    loadRetention();
  }
}

async function purgeNow() {
  if (!confirm('Run data retention purge now? This will delete old events.')) return;
  const r = await authFetch(API + '/v1/admin/retention/purge', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ confirm: true }),
  });
  if (r && r.ok) {
    const data = await r.json();
    toast('Purge complete: ' + data.raw_events_deleted + ' raw, ' + data.hourly_counts_deleted + ' hourly deleted', 'success');
    loadRetention();
  }
}

// Project filter auto-refresh
document.getElementById('filterProject').addEventListener('change', () => { loadErrors(); loadStats(); loadTrend(); });

// ── Alert Management ──
function toggleAlertForm() {
  const form = document.getElementById('alertForm');
  form.style.display = form.style.display === 'none' ? 'flex' : 'none';
}

document.getElementById('newAlertType').addEventListener('change', function() {
  document.getElementById('thresholdFields').style.display = this.value === 'threshold' ? 'block' : 'none';
});

async function loadAlerts() {
  const list = document.getElementById('alertsList');
  if (!list) return;
  try {
    const r = await authFetch(API + '/v1/alerts');
    if (!r || !r.ok) return;
    const alerts = await r.json();
    list.replaceChildren();
    for (const a of alerts) {
      const enabledBadge = a.enabled
        ? el('span', { className: 'badge badge-active alert-item-type' }, 'enabled')
        : el('span', { className: 'badge badge-used alert-item-type' }, 'disabled');

      const typeBadge = el('span', { className: 'badge badge-admin alert-item-type', style: { marginLeft: '4px' } }, a.rule_type);

      const actions = el('div', { className: 'alert-item-actions' });

      const toggleBtn = el('button', { onclick: () => toggleAlert(a.id, !a.enabled) }, a.enabled ? 'Disable' : 'Enable');
      actions.appendChild(toggleBtn);

      const testBtn = el('button', { onclick: () => testAlert(a.id) }, 'Test');
      actions.appendChild(testBtn);

      const addChBtn = el('button', { onclick: () => promptAddChannel(a.id) }, '+ Channel');
      actions.appendChild(addChBtn);

      const delBtn = el('button', { className: 'remove-btn', onclick: () => deleteAlert(a.id) }, 'Delete');
      actions.appendChild(delBtn);

      const channelsDiv = el('div', { className: 'alert-channels-list' });

      // Load channels for this rule
      const cr = await authFetch(API + '/v1/alerts/' + a.id + '/channels');
      if (cr && cr.ok) {
        const channels = await cr.json();
        channels.forEach(ch => {
          const label = ch.channel_type === 'slack' ? 'Slack' : ch.channel_type === 'email' ? 'Email' : 'Webhook';
          const detail = ch.config.webhook_url || ch.config.url || ch.config.to || '';
          const chEl = el('div', { className: 'alert-channel' }, [
            span(label + ': ' + detail.substring(0, 30) + (detail.length > 30 ? '...' : '')),
            el('button', { className: 'remove-btn', style: { fontSize: '9px', padding: '2px 6px' }, onclick: () => deleteChannel(a.id, ch.id) }, 'x'),
          ]);
          channelsDiv.appendChild(chEl);
        });
      }

      const item = el('div', { className: 'alert-item' }, [
        el('div', { className: 'alert-item-header' }, [
          el('span', { className: 'alert-item-name' }, a.name),
          el('div', null, [enabledBadge, typeBadge]),
        ]),
        a.description ? el('div', { className: 'alert-item-desc' }, a.description) : null,
        channelsDiv,
        actions,
      ]);
      list.appendChild(item);
    }
  } catch {}
}

async function createAlert() {
  const nameInput = document.getElementById('newAlertName');
  const name = nameInput.value.trim();
  clearInputError(nameInput);
  if (!name) { showInputError(nameInput, 'Alert name is required'); return; }
  const desc = document.getElementById('newAlertDesc').value.trim() || undefined;
  const type = document.getElementById('newAlertType').value;
  let config;
  if (type === 'new_issue') {
    config = { type: 'new_issue' };
  } else {
    const threshInput = document.getElementById('newAlertThreshold');
    const windowInput = document.getElementById('newAlertWindow');
    const threshold = parseInt(threshInput.value);
    const window = parseInt(windowInput.value);
    clearInputError(threshInput);
    clearInputError(windowInput);
    if (!threshold || threshold < 1) { showInputError(threshInput, 'Enter a threshold count'); return; }
    if (!window || window < 1) { showInputError(windowInput, 'Enter a window in seconds'); return; }
    config = { type: 'threshold', threshold: threshold, window_secs: window };
  }
  const pid = getSelectedProjectId() || undefined;
  try {
    const r = await authFetch(API + '/v1/alerts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, config, project_id: pid, description: desc }),
    });
    if (r && r.ok) {
      nameInput.value = '';
      document.getElementById('newAlertDesc').value = '';
      document.getElementById('alertForm').style.display = 'none';
      toast('Alert "' + name + '" created', 'success');
      loadAlerts();
    } else if (r) {
      const err = await r.text();
      toast(err || 'Failed to create alert', 'error');
    }
  } catch (e) {
    toast('Network error creating alert', 'error');
  }
}

async function toggleAlert(id, enabled) {
  await authFetch(API + '/v1/alerts/' + id, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ enabled }),
  });
  loadAlerts();
}

async function testAlert(id) {
  try {
    const r = await authFetch(API + '/v1/alerts/' + id + '/test', { method: 'POST' });
    if (r && r.ok) toast('Test notification sent', 'success');
    else toast('Failed to send test notification', 'error');
  } catch (e) {
    toast('Network error sending test', 'error');
  }
}

async function deleteAlert(id) {
  if (!confirm('Delete this alert rule?')) return;
  await authFetch(API + '/v1/alerts/' + id, { method: 'DELETE' });
  loadAlerts();
}

function promptAddChannel(ruleId) {
  const type = prompt('Channel type: slack, webhook, or email');
  if (!type || (type !== 'slack' && type !== 'webhook' && type !== 'email')) return;
  if (type === 'email') {
    const to = prompt('Recipient email address:');
    if (!to || !to.includes('@')) return;
    addChannel(ruleId, { type: 'email', to: to });
  } else {
    const url = prompt(type === 'slack' ? 'Slack webhook URL:' : 'Webhook URL:');
    if (!url) return;
    const config = type === 'slack' ? { type: 'slack', webhook_url: url } : { type: 'webhook', url: url };
    addChannel(ruleId, config);
  }
}

async function addChannel(ruleId, config) {
  await authFetch(API + '/v1/alerts/' + ruleId + '/channels', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ config }),
  });
  loadAlerts();
}

async function deleteChannel(ruleId, channelId) {
  await authFetch(API + '/v1/alerts/' + ruleId + '/channels/' + channelId, { method: 'DELETE' });
  loadAlerts();
}

// ── API Tokens ──
function toggleTokenForm() {
  const form = document.getElementById('tokenForm');
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
  if (form.style.display === 'block') {
    // Populate project dropdown
    const sel = document.getElementById('newTokenProject');
    sel.replaceChildren();
    (window._projects || []).forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.name;
      sel.appendChild(opt);
    });
  }
}

async function loadTokens() {
  const list = document.getElementById('tokensList');
  if (!list) return;
  list.replaceChildren();

  // Load tokens for each project
  const projects = window._projects || [];
  for (const proj of projects) {
    const r = await authFetch(API + '/v1/tokens?project_id=' + encodeURIComponent(proj.id));
    if (!r || !r.ok) continue;
    const tokens = await r.json();
    tokens.forEach(t => {
      const isRevoked = !!t.revoked_at;
      const lastUsed = t.last_used_at ? new Date(t.last_used_at * 1000).toLocaleDateString() : 'never';
      const scopes = t.scopes.join(', ');
      const item = el('div', { className: 'settings-item' + (isRevoked ? ' revoked' : '') }, [
        el('div', null, [
          el('span', { className: 'name' }, t.name),
          el('span', { className: 'badge' }, t.token_prefix + '...'),
        ]),
        el('div', { style: 'font-size:10px;color:var(--text-dim);margin-top:2px;' },
          proj.name + ' · ' + scopes + ' · last used: ' + lastUsed),
        ...(!isRevoked ? [el('button', {
          className: 'remove-btn',
          onclick: () => revokeToken(t.id),
          title: 'Revoke token',
        }, 'Revoke')] : [el('span', { style: 'font-size:10px;color:var(--red-text);' }, 'revoked')]),
      ]);
      list.appendChild(item);
    });
  }
}

async function createToken() {
  const name = document.getElementById('newTokenName').value.trim();
  const projectId = document.getElementById('newTokenProject').value;
  const scopes = [...document.querySelectorAll('.token-scope:checked')].map(cb => cb.value);

  if (!name) { showToast('Token name is required', 'error'); return; }
  if (!scopes.length) { showToast('Select at least one scope', 'error'); return; }

  const r = await authFetch(API + '/v1/tokens', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, project_id: projectId, scopes }),
  });
  if (!r) return;
  if (!r.ok) {
    const err = await r.json();
    showToast(err.error || 'Failed to create token', 'error');
    return;
  }
  const data = await r.json();
  // Show the token once
  document.getElementById('newTokenValue').textContent = data.token;
  document.getElementById('newTokenResult').style.display = 'block';
  document.getElementById('tokenForm').style.display = 'none';
  document.getElementById('newTokenName').value = '';
  showToast('API token created');
  loadTokens();
}

function copyToken() {
  const token = document.getElementById('newTokenValue').textContent;
  navigator.clipboard.writeText(token).then(() => showToast('Copied to clipboard'));
}

async function revokeToken(id) {
  if (!confirm('Revoke this token? API calls using it will stop working.')) return;
  const r = await authFetch(API + '/v1/tokens/' + id, { method: 'DELETE' });
  if (r && r.ok) {
    showToast('Token revoked');
    loadTokens();
  }
}

async function loadSourceMaps() {
  const list = document.getElementById('sourcemapsList');
  if (!list) return;
  list.replaceChildren();
  // Populate the project dropdown
  const projSel = document.getElementById('smProjectSlug');
  if (projSel) {
    projSel.replaceChildren();
    projects.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.slug;
      opt.textContent = p.name;
      projSel.appendChild(opt);
    });
  }
  // Load for each project
  for (const p of projects) {
    try {
      const r = await authFetch(API + '/v1/projects/' + encodeURIComponent(p.slug) + '/sourcemaps');
      if (!r || !r.ok) continue;
      const maps = await r.json();
      maps.forEach(m => {
        const item = el('div', { className: 'settings-item' }, [
          el('div', null, [
            el('span', { className: 'name' }, m.filename),
            el('span', { className: 'badge badge-active', style: 'margin-left:6px;' }, m.release),
            el('span', { style: 'margin-left:6px;font-size:10px;color:var(--text-dim);' }, p.slug),
          ]),
          el('div', { style: 'display:flex;align-items:center;gap:8px;' }, [
            el('span', { style: 'font-size:10px;color:var(--text-dim);' }, timeAgo(m.uploaded_at)),
            el('button', { className: 'remove-btn', onclick: () => deleteSourceMap(p.slug, m.id) }, 'Delete'),
          ]),
        ]);
        list.appendChild(item);
      });
    } catch {}
  }
  if (!list.hasChildNodes()) {
    list.appendChild(el('div', { style: 'color:var(--text-dim);font-size:11px;padding:8px 0;' }, 'No source maps uploaded yet.'));
  }
}

async function uploadSourceMap() {
  const projSel = document.getElementById('smProjectSlug');
  const releaseInput = document.getElementById('smRelease');
  const fileInput = document.getElementById('smFile');
  const slug = projSel.value;
  const release = releaseInput.value.trim();
  clearInputError(releaseInput);
  let hasError = false;
  if (!slug) { toast('Select a project first', 'error'); return; }
  if (!release) { showInputError(releaseInput, 'Release version is required'); hasError = true; }
  if (!fileInput.files.length) { toast('Select a .map file to upload', 'error'); hasError = true; }
  if (hasError) return;
  try {
    const formData = new FormData();
    formData.append('release', release);
    formData.append('file', fileInput.files[0]);
    const r = await authFetch(API + '/v1/projects/' + encodeURIComponent(slug) + '/sourcemaps', {
      method: 'POST',
      body: formData,
    });
    if (r && r.ok) {
      releaseInput.value = '';
      fileInput.value = '';
      toast('Source map uploaded for ' + slug + '@' + release, 'success');
      loadSourceMaps();
    } else if (r) {
      const err = await r.text();
      toast(err || 'Failed to upload source map', 'error');
    }
  } catch (e) {
    toast('Network error uploading source map', 'error');
  }
}

async function deleteSourceMap(slug, id) {
  if (!confirm('Delete this source map?')) return;
  await authFetch(API + '/v1/projects/' + encodeURIComponent(slug) + '/sourcemaps/' + id, { method: 'DELETE' });
  loadSourceMaps();
}

// -- Welcome Modal --
let welcomeStep = 0;
let welcomeKey = '';

function showWelcome() {
  welcomeStep = 0;
  welcomeKey = 'your-api-key';
  renderWelcomeStep();
  document.getElementById('welcomeModal').classList.remove('hidden');
}

function closeWelcome() {
  document.getElementById('welcomeModal').classList.add('hidden');
  localStorage.setItem('bloop_onboarded', '1');
}

function nextWelcomeStep() {
  welcomeStep++;
  if (welcomeStep > 2) { closeWelcome(); return; }
  renderWelcomeStep();
}

function prevWelcomeStep() {
  if (welcomeStep > 0) welcomeStep--;
  renderWelcomeStep();
}

function renderWelcomeStep() {
  const title = document.getElementById('modalTitle');
  const subtitle = document.getElementById('modalSubtitle');
  const body = document.getElementById('modalBody');
  const nextBtn = document.getElementById('modalNext');
  const skipBtn = document.getElementById('modalSkip');
  for (let i = 0; i < 3; i++) {
    document.getElementById('dot' + i).classList.toggle('active', i === welcomeStep);
  }

  if (welcomeStep === 0) {
    title.textContent = 'Welcome to Bloop';
    subtitle.textContent = 'Self-hosted error tracking, ready in 60 seconds.';
    body.textContent = '';
    const wrap = el('div', { style: 'text-align:center;padding:8px 0;' }, [
      el('div', { style: 'font-size:48px;margin-bottom:16px;' }, '\u{1F41B}'),
      el('p', { style: 'color:var(--text-secondary);font-size:13px;line-height:1.6;max-width:380px;margin:0 auto;' },
        'Bloop captures errors from your apps and APIs, deduplicates them with smart fingerprinting, and alerts you when things break.'),
    ]);
    body.appendChild(wrap);
    nextBtn.textContent = 'Get Started';
    skipBtn.textContent = 'Skip';
    skipBtn.onclick = closeWelcome;
  } else if (welcomeStep === 1) {
    title.textContent = 'Your API Key';
    subtitle.textContent = 'Use this key to authenticate your SDK. Click to copy.';
    body.textContent = '';
    const label = el('div', { className: 'api-key-label' }, 'Project API Key');
    const keyDisp = el('div', { className: 'api-key-display' }, welcomeKey);
    keyDisp.onclick = function() {
      navigator.clipboard.writeText(welcomeKey);
      this.textContent = 'Copied!';
      const k = welcomeKey;
      setTimeout(() => { this.textContent = k; }, 1500);
    };
    const envLabel = el('div', { className: 'snippet-section-label' }, 'Environment variable');
    const envVal = 'BLOOP_API_KEY=' + welcomeKey + '\nBLOOP_ENDPOINT=' + window.location.origin;
    const envCode = el('div', { className: 'snippet-code', style: 'font-size:11px;' });
    envCode.textContent = envVal;
    const envCopy = el('button', { className: 'snippet-copy' }, 'Copy');
    envCopy.onclick = function() {
      navigator.clipboard.writeText(envVal);
      this.textContent = 'Copied!';
      setTimeout(() => { this.textContent = 'Copy'; }, 1200);
    };
    envCode.appendChild(envCopy);
    const envWrap = el('div', { style: 'margin-top:16px;' }, [envLabel, envCode]);
    body.appendChild(label);
    body.appendChild(keyDisp);
    body.appendChild(envWrap);
    nextBtn.textContent = 'Next';
    skipBtn.textContent = 'Back';
    skipBtn.onclick = prevWelcomeStep;
  } else if (welcomeStep === 2) {
    title.textContent = 'Install an SDK';
    subtitle.textContent = 'Choose your platform and start capturing errors.';
    body.textContent = '';
    body.appendChild(buildSnippetTabsDOM(welcomeKey));
    nextBtn.textContent = 'Done';
    skipBtn.textContent = 'Back';
    skipBtn.onclick = prevWelcomeStep;
    setTimeout(() => switchSnippetTab('curl'), 0);
  }
}

function buildSnippetTabsDOM(key) {
  const endpoint = window.location.origin;
  const tabs = [
    { id: 'curl', label: 'cURL' },
    { id: 'typescript', label: 'TypeScript' },
    { id: 'react-native', label: 'React Native' },
    { id: 'swift', label: 'Swift' },
    { id: 'kotlin', label: 'Kotlin' },
    { id: 'python', label: 'Python' },
  ];
  const snippets = {
    curl: 'BODY=\'{"timestamp":'+ Math.floor(Date.now()/1000) +',"source":"api","environment":"production","release":"1.0.0","error_type":"TestError","message":"Hello from Bloop!"}\'\n'
      + 'SIG=$(echo -n "$BODY" | openssl dgst -sha256 -hmac "' + key + '" | awk \'{print $2}\')\n\n'
      + 'curl -X POST ' + endpoint + '/v1/ingest \\\n'
      + '  -H "Content-Type: application/json" \\\n'
      + '  -H "X-Signature: $SIG" \\\n'
      + '  -H "X-Project-Key: ' + key + '" \\\n'
      + '  -d "$BODY"',
    typescript: 'import { BloopClient } from "@bloop/sdk";\n\n'
      + 'const bloop = new BloopClient({\n'
      + '  endpoint: "' + endpoint + '",\n'
      + '  projectKey: "' + key + '",\n'
      + '  environment: "production",\n'
      + '  release: "1.0.0",\n'
      + '});\n\n'
      + 'try {\n'
      + '  riskyOperation();\n'
      + '} catch (err) {\n'
      + '  bloop.captureError(err);\n'
      + '}',
    'react-native': 'import { useBloop, BloopErrorBoundary }\n  from "@bloop/react-native";\n\n'
      + 'function App() {\n'
      + '  const bloop = useBloop({\n'
      + '    endpoint: "' + endpoint + '",\n'
      + '    projectKey: "' + key + '",\n'
      + '    environment: "production",\n'
      + '    release: "1.0.0",\n'
      + '  });\n\n'
      + '  return (\n'
      + '    <BloopErrorBoundary client={bloop}\n'
      + '      fallback={<ErrorScreen />}>\n'
      + '      <Navigation />\n'
      + '    </BloopErrorBoundary>\n'
      + '  );\n'
      + '}',
    swift: 'let client = BloopClient(\n'
      + '  url: URL(string: "' + endpoint + '")!,\n'
      + '  secret: "' + key + '"\n'
      + ')\n\n'
      + 'try await client.send(event: [\n'
      + '  "timestamp": Int(Date().timeIntervalSince1970),\n'
      + '  "source": "ios",\n'
      + '  "environment": "production",\n'
      + '  "release": "1.0.0",\n'
      + '  "error_type": "NetworkError",\n'
      + '  "message": "Request timed out",\n'
      + '])',
    kotlin: 'val bloop = BloopClient(\n'
      + '  "' + endpoint + '",\n'
      + '  "' + key + '"\n'
      + ')\n\n'
      + 'bloop.send(JSONObject().apply {\n'
      + '  put("timestamp", System.currentTimeMillis() / 1000)\n'
      + '  put("source", "android")\n'
      + '  put("environment", "production")\n'
      + '  put("release", "1.0.0")\n'
      + '  put("error_type", "IllegalStateException")\n'
      + '  put("message", "Fragment not attached")\n'
      + '})',
    python: 'import hashlib, hmac, json, time, requests\n\n'
      + 'BLOOP_URL = "' + endpoint + '"\n'
      + 'API_KEY = "' + key + '"\n\n'
      + 'def send_error(error_type, message, **kw):\n'
      + '  event = {"timestamp": int(time.time()),\n'
      + '    "source": "api", "environment": "production",\n'
      + '    "release": "1.0.0", "error_type": error_type,\n'
      + '    "message": message, **kw}\n'
      + '  body = json.dumps(event, separators=(",",":"))\n'
      + '  sig = hmac.new(API_KEY.encode(),\n'
      + '    body.encode(), hashlib.sha256).hexdigest()\n'
      + '  requests.post(f"{BLOOP_URL}/v1/ingest",\n'
      + '    data=body, headers={\n'
      + '      "Content-Type": "application/json",\n'
      + '      "X-Signature": sig,\n'
      + '      "X-Project-Key": API_KEY})',
  };

  const frag = document.createDocumentFragment();
  const tabBar = el('div', { className: 'snippet-tabs' });
  tabs.forEach(t => {
    const btn = el('button', { className: 'snippet-tab', id: 'stab-' + t.id }, t.label);
    btn.onclick = function() { switchSnippetTab(t.id); };
    tabBar.appendChild(btn);
  });
  frag.appendChild(tabBar);
  tabs.forEach(t => {
    const codeDiv = el('div', { className: 'snippet-code', id: 'scode-' + t.id, style: 'display:none;' });
    codeDiv.textContent = snippets[t.id];
    const copyBtn = el('button', { className: 'snippet-copy' }, 'Copy');
    copyBtn.onclick = function() { copySnippet(t.id); };
    codeDiv.appendChild(copyBtn);
    frag.appendChild(codeDiv);
  });
  return frag;
}

function buildSnippetTabs(key) {
  const endpoint = window.location.origin;
  const tabs = [
    { id: 'curl', label: 'cURL' },
    { id: 'typescript', label: 'TypeScript' },
    { id: 'react-native', label: 'React Native' },
    { id: 'swift', label: 'Swift' },
    { id: 'kotlin', label: 'Kotlin' },
    { id: 'python', label: 'Python' },
  ];
  const snippets = {
    curl: 'BODY=\'{"timestamp":'+ Math.floor(Date.now()/1000) +',"source":"api","environment":"production","release":"1.0.0","error_type":"TestError","message":"Hello from Bloop!"}\'\n'
      + 'SIG=$(echo -n "$BODY" | openssl dgst -sha256 -hmac "' + key + '" | awk \'{print $2}\')\n\n'
      + 'curl -X POST ' + endpoint + '/v1/ingest \\\n'
      + '  -H "Content-Type: application/json" \\\n'
      + '  -H "X-Signature: $SIG" \\\n'
      + '  -H "X-Project-Key: ' + key + '" \\\n'
      + '  -d "$BODY"',
    typescript: 'import { BloopClient } from "@bloop/sdk";\n\n'
      + 'const bloop = new BloopClient({\n'
      + '  endpoint: "' + endpoint + '",\n'
      + '  projectKey: "' + key + '",\n'
      + '  environment: "production",\n'
      + '  release: "1.0.0",\n'
      + '});\n\n'
      + 'try {\n'
      + '  riskyOperation();\n'
      + '} catch (err) {\n'
      + '  bloop.captureError(err);\n'
      + '}',
    'react-native': 'import { useBloop, BloopErrorBoundary }\n  from "@bloop/react-native";\n\n'
      + 'function App() {\n'
      + '  const bloop = useBloop({\n'
      + '    endpoint: "' + endpoint + '",\n'
      + '    projectKey: "' + key + '",\n'
      + '    environment: "production",\n'
      + '    release: "1.0.0",\n'
      + '  });\n\n'
      + '  return (\n'
      + '    <BloopErrorBoundary client={bloop}\n'
      + '      fallback={<ErrorScreen />}>\n'
      + '      <Navigation />\n'
      + '    </BloopErrorBoundary>\n'
      + '  );\n'
      + '}',
    swift: 'let client = BloopClient(\n'
      + '  url: URL(string: "' + endpoint + '")!,\n'
      + '  secret: "' + key + '"\n'
      + ')\n\n'
      + 'try await client.send(event: [\n'
      + '  "timestamp": Int(Date().timeIntervalSince1970),\n'
      + '  "source": "ios",\n'
      + '  "environment": "production",\n'
      + '  "release": "1.0.0",\n'
      + '  "error_type": "NetworkError",\n'
      + '  "message": "Request timed out",\n'
      + '])',
    kotlin: 'val bloop = BloopClient(\n'
      + '  "' + endpoint + '",\n'
      + '  "' + key + '"\n'
      + ')\n\n'
      + 'bloop.send(JSONObject().apply {\n'
      + '  put("timestamp", System.currentTimeMillis() / 1000)\n'
      + '  put("source", "android")\n'
      + '  put("environment", "production")\n'
      + '  put("release", "1.0.0")\n'
      + '  put("error_type", "IllegalStateException")\n'
      + '  put("message", "Fragment not attached")\n'
      + '})',
    python: 'import hashlib, hmac, json, time, requests\n\n'
      + 'BLOOP_URL = "' + endpoint + '"\n'
      + 'API_KEY = "' + key + '"\n\n'
      + 'def send_error(error_type, message, **kw):\n'
      + '  event = {"timestamp": int(time.time()),\n'
      + '    "source": "api", "environment": "production",\n'
      + '    "release": "1.0.0", "error_type": error_type,\n'
      + '    "message": message, **kw}\n'
      + '  body = json.dumps(event, separators=(",",":"))\n'
      + '  sig = hmac.new(API_KEY.encode(),\n'
      + '    body.encode(), hashlib.sha256).hexdigest()\n'
      + '  requests.post(f"{BLOOP_URL}/v1/ingest",\n'
      + '    data=body, headers={\n'
      + '      "Content-Type": "application/json",\n'
      + '      "X-Signature": sig,\n'
      + '      "X-Project-Key": API_KEY})',
  };

  let h = '<div class="snippet-tabs">';
  tabs.forEach(t => {
    h += '<button class="snippet-tab" id="stab-' + t.id + '" onclick="switchSnippetTab(\'' + t.id + '\')">' + t.label + '</button>';
  });
  h += '</div>';
  tabs.forEach(t => {
    h += '<div class="snippet-code" id="scode-' + t.id + '" style="display:none;">'
      + escapeHtml(snippets[t.id])
      + '<button class="snippet-copy" onclick="copySnippet(\'' + t.id + '\')">Copy</button></div>';
  });
  return h;
}

function switchSnippetTab(id) {
  document.querySelectorAll('.snippet-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.snippet-code[id^="scode-"]').forEach(c => c.style.display = 'none');
  const tab = document.getElementById('stab-' + id);
  const code = document.getElementById('scode-' + id);
  if (tab) tab.classList.add('active');
  if (code) code.style.display = 'block';
}

function copySnippet(id) {
  const code = document.getElementById('scode-' + id);
  if (!code) return;
  const text = code.textContent.replace('Copy', '').trim();
  navigator.clipboard.writeText(text);
  const btn = code.querySelector('.snippet-copy');
  if (btn) { btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = 'Copy', 1200); }
}

function escapeHtml(str) {
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// -- First-Event Polling --
let firstEventPolling = null;
let hadEventsOnLoad = false;

function startFirstEventPolling() {
  if (firstEventPolling) return;
  firstEventPolling = setInterval(async () => {
    try {
      const r = await authFetch(API + '/v1/stats');
      if (!r || !r.ok) return;
      const stats = await r.json();
      if (stats.total_errors > 0) {
        clearInterval(firstEventPolling);
        firstEventPolling = null;
        toast('First error received! Refreshing...', 'success', 5000);
        loadErrors();
        loadStats();
        loadTrend();
      }
    } catch {}
  }, 3000);
}

// Init
loadHealth();
loadProjects().then(() => {
  loadStats().then(stats => {
    hadEventsOnLoad = stats && stats.total_errors > 0;
  });
  loadTrend();
  loadErrors();
  // Show welcome modal on first visit
  if (!localStorage.getItem('bloop_onboarded')) {
    setTimeout(showWelcome, 800);
  }
});
setInterval(loadHealth, 30000);
setInterval(loadStats, 30000);
setInterval(loadErrors, 60000);
setInterval(loadTrend, 60000);

// ── Insights (Analytics) ──
let insightsOpen = false;
let currentInsightsTab = 'spikes';

// Feature probe: show Insights button only if analytics endpoints are compiled in
(async function probeAnalytics() {
  try {
    const pp = projectParam();
    const r = await fetch(API + '/v1/analytics/spikes?limit=1' + (pp ? '&' + pp : ''));
    if (r && r.status === 200) {
      document.getElementById('insightsBtn').classList.add('visible');
    }
  } catch {}
})();

function toggleInsights() {
  insightsOpen = !insightsOpen;
  const panel = document.getElementById('insightsPanel');
  if (insightsOpen) {
    panel.classList.remove('hidden');
    switchInsightsTab(currentInsightsTab);
  } else {
    panel.classList.add('hidden');
  }
}

function switchInsightsTab(tab) {
  currentInsightsTab = tab;
  document.querySelectorAll('.insights-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.insights-tab').forEach(t => {
    if (t.textContent.toLowerCase().startsWith(tab.substring(0, 4))) t.classList.add('active');
  });
  const content = document.getElementById('insightsContent');
  content.innerHTML = '';
  const loading = document.createElement('div');
  loading.className = 'insights-loading';
  loading.textContent = 'Loading...';
  content.appendChild(loading);

  const loaders = {
    spikes: loadInsightsSpikes,
    movers: loadInsightsMovers,
    correlations: loadInsightsCorrelations,
    releases: loadInsightsReleases,
    environments: loadInsightsEnvironments,
  };
  if (loaders[tab]) loaders[tab]();
}

async function loadInsightsSpikes() {
  const content = document.getElementById('insightsContent');
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/analytics/spikes?hours=72&limit=20' + (pp ? '&' + pp : ''));
    if (!r) return;
    const data = await r.json();
    content.innerHTML = '';
    if (!data.spikes || !data.spikes.length) {
      content.innerHTML = '<div class="insights-empty">No anomalous spikes detected in the last ' + data.window_hours + ' hours</div>';
      return;
    }
    const maxZ = Math.max(...data.spikes.map(s => s.zscore), 1);
    data.spikes.forEach(s => {
      const row = el('div', { className: 'spike-row' }, [
        el('div', { className: 'spike-bar-wrap' }, el('div', {
          className: 'spike-bar',
          style: 'width:' + Math.min(100, (s.zscore / maxZ) * 100).toFixed(0) + '%;background:' + (s.zscore >= 4 ? 'var(--red)' : s.zscore >= 3 ? 'var(--accent)' : 'var(--text-dim)')
        })),
        el('div', { className: 'spike-info' }, [
          el('div', { className: 'spike-msg' }, s.message || s.error_type),
          el('div', { className: 'spike-meta' }, s.error_type + ' \u00B7 ' + s.count + ' events \u00B7 ' + new Date(s.hour_bucket).toLocaleString()),
        ]),
        el('div', { className: 'spike-zscore' }, 'z=' + s.zscore.toFixed(1)),
      ]);
      content.appendChild(row);
    });
  } catch (e) {
    content.innerHTML = '<div class="insights-empty">Failed to load spike data</div>';
  }
}

async function loadInsightsMovers() {
  const content = document.getElementById('insightsContent');
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/analytics/movers?hours=24&limit=20' + (pp ? '&' + pp : ''));
    if (!r) return;
    const data = await r.json();
    content.innerHTML = '';
    if (!data.movers || !data.movers.length) {
      content.innerHTML = '<div class="insights-empty">No significant changes in the last ' + data.window_hours + ' hours</div>';
      return;
    }
    data.movers.forEach(m => {
      const isUp = m.delta > 0;
      const arrow = isUp ? '\u2191' : m.delta < 0 ? '\u2193' : '\u2192';
      const row = el('div', { className: 'mover-row' }, [
        el('div', { className: 'mover-delta ' + (isUp ? 'up' : m.delta < 0 ? 'down' : '') }, arrow + ' ' + Math.abs(m.delta)),
        el('div', { className: 'mover-info' }, [
          el('div', { className: 'mover-msg' }, m.message || m.error_type),
          el('div', { className: 'mover-counts' }, m.count_previous + ' \u2192 ' + m.count_current),
        ]),
        el('span', { className: 'mover-pct ' + (isUp ? 'up' : m.delta < 0 ? 'down' : '') },
          (m.delta_pct >= 0 ? '+' : '') + m.delta_pct.toFixed(0) + '%'),
      ]);
      content.appendChild(row);
    });
  } catch (e) {
    content.innerHTML = '<div class="insights-empty">Failed to load movers data</div>';
  }
}

async function loadInsightsCorrelations() {
  const content = document.getElementById('insightsContent');
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/analytics/correlations?hours=72&limit=20' + (pp ? '&' + pp : ''));
    if (!r) return;
    const data = await r.json();
    content.innerHTML = '';
    if (!data.pairs || !data.pairs.length) {
      content.innerHTML = '<div class="insights-empty">No correlated error pairs found (requires \u22656 data points, correlation \u22650.7)</div>';
      return;
    }
    data.pairs.forEach(p => {
      const card = el('div', { className: 'corr-card' }, [
        el('div', { className: 'corr-pair' }, [
          el('span', { className: 'corr-fp' }, p.message_a || p.fingerprint_a.substring(0, 12)),
          el('span', { className: 'corr-arrow' }, '\u2194'),
          el('span', { className: 'corr-fp' }, p.message_b || p.fingerprint_b.substring(0, 12)),
        ]),
        el('div', { className: 'corr-score' }, 'r=' + p.correlation.toFixed(2)),
      ]);
      content.appendChild(card);
    });
  } catch (e) {
    content.innerHTML = '<div class="insights-empty">Failed to load correlation data</div>';
  }
}

async function loadInsightsReleases() {
  const content = document.getElementById('insightsContent');
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/analytics/releases?limit=20' + (pp ? '&' + pp : ''));
    if (!r) return;
    const data = await r.json();
    content.innerHTML = '';
    if (!data.releases || !data.releases.length) {
      content.innerHTML = '<div class="insights-empty">No release data available</div>';
      return;
    }
    data.releases.forEach(rel => {
      const scoreClass = rel.impact_score > 50 ? 'bad' : rel.impact_score < 0 ? 'good' : 'ok';
      const card = el('div', { className: 'release-card' }, [
        el('div', { className: 'release-header' }, [
          el('span', { className: 'release-name' }, rel.release),
          el('span', { className: 'release-score ' + scoreClass }, 'Score: ' + rel.impact_score.toFixed(0)),
        ]),
        el('div', { className: 'release-stats' }, [
          el('span', null, 'Errors: '),
          el('span', { className: 'release-stat-val' }, String(rel.error_count)),
          el('span', null, ' \u00B7 New: '),
          el('span', { className: 'release-stat-val' }, String(rel.new_fingerprints)),
          el('span', null, ' \u00B7 Delta: '),
          el('span', { className: 'release-stat-val' }, (rel.error_delta >= 0 ? '+' : '') + rel.error_delta),
        ]),
      ]);
      content.appendChild(card);
    });
  } catch (e) {
    content.innerHTML = '<div class="insights-empty">Failed to load release data</div>';
  }
}

async function loadInsightsEnvironments() {
  const content = document.getElementById('insightsContent');
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/analytics/environments?hours=72&limit=20' + (pp ? '&' + pp : ''));
    if (!r) return;
    const data = await r.json();
    content.innerHTML = '';
    if (!data.environments || !data.environments.length) {
      content.innerHTML = '<div class="insights-empty">No environment data available</div>';
      return;
    }
    const table = document.createElement('table');
    table.className = 'env-table';
    const thead = el('thead', null, el('tr', null, [
      el('th', null, 'Environment'),
      el('th', null, 'Total'),
      el('th', null, '%'),
      el('th', null, 'Unique'),
      el('th', null, 'P50/h'),
      el('th', null, 'P90/h'),
      el('th', null, 'P99/h'),
    ]));
    table.appendChild(thead);
    const tbody = document.createElement('tbody');
    data.environments.forEach(e => {
      const tr = el('tr', null, [
        el('td', null, e.environment),
        el('td', null, String(e.total_count)),
        el('td', null, [
          (() => {
            const bar = document.createElement('span');
            bar.className = 'env-pct-bar';
            const fill = document.createElement('span');
            fill.className = 'env-pct-fill';
            fill.style.width = Math.min(100, e.pct_of_total).toFixed(0) + '%';
            bar.appendChild(fill);
            return bar;
          })(),
          document.createTextNode(e.pct_of_total.toFixed(1) + '%'),
        ]),
        el('td', null, String(e.unique_errors)),
        el('td', null, e.p50_hourly.toFixed(1)),
        el('td', null, e.p90_hourly.toFixed(1)),
        el('td', null, e.p99_hourly.toFixed(1)),
      ]);
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    content.appendChild(table);
  } catch (err) {
    content.innerHTML = '<div class="insights-empty">Failed to load environment data</div>';
  }
}

// ── LLM Tracing ──
let llmOpen = false;
let currentLlmTab = 'overview';

// Feature probe: show LLM button only if llm-tracing endpoints are compiled in
(async function probeLlm() {
  try {
    const pp = projectParam();
    const r = await fetch(API + '/v1/llm/overview?hours=1' + (pp ? '&' + pp : ''), { credentials: 'include' });
    if (r && r.status === 200) {
      document.getElementById('llmBtn').classList.add('visible');
    }
  } catch {}
})();

function showPage(page) {
  // Update primary navigation
  document.querySelectorAll('.nav-primary-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.page === page) btn.classList.add('active');
  });
  
  // Hide all pages
  document.querySelectorAll('.page-view').forEach(view => {
    view.classList.remove('active');
  });
  
  // Show selected page
  const pageMap = {
    'errors': 'errorsPage',
    'llm': 'llmPage',
    'settings': 'settingsPanel'
  };
  
  const targetId = pageMap[page];
  if (targetId) {
    const target = document.getElementById(targetId);
    if (target) {
      if (page === 'settings') {
        target.classList.remove('hidden');
      } else {
        target.classList.add('active');
      }
    }
  }
  
  // Special handling for LLM page
  if (page === 'llm') {
    switchLlmTab(currentLlmTab);
  }
  
  window.scrollTo(0, 0);
}

function toggleLlm() {
  showPage('llm');
}

function switchLlmTab(tab) {
  currentLlmTab = tab;
  
  // Update secondary navigation (new style)
  document.querySelectorAll('#llmPage .nav-secondary-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.llmTab === tab) btn.classList.add('active');
  });
  
  // Also update old style tabs if they exist (backward compatibility)
  document.querySelectorAll('#llmPanel .insights-tab').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.llmTab === tab) btn.classList.add('active');
  });
  
  const content = document.getElementById('llmContent');
  content.innerHTML = '<div class="insights-loading">Loading...</div>';

  const loaders = {
    overview: loadLlmOverview,
    usage: loadLlmUsage,
    latency: loadLlmLatency,
    models: loadLlmModels,
    traces: loadLlmTraces,
    search: loadLlmSearch,
    prompts: loadLlmPrompts,
    scores: loadLlmScores,
    rag: loadLlmRag,
    experiments: loadLlmExperiments,
  };
  if (loaders[tab]) loaders[tab]();
}

function fmtCost(micros) {
  return '$' + (micros / 1000000).toFixed(4);
}

function fmtTokens(n) {
  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
  return n.toString();
}

async function loadLlmOverview() {
  const content = document.getElementById('llmContent');
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/llm/overview?hours=24' + (pp ? '&' + pp : ''));
    if (!r) return;
    const d = await r.json();
    content.innerHTML = '';
    const grid = el('div', { style: 'display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;' }, [
      statCard('Traces', d.total_traces),
      statCard('Spans', d.total_spans),
      statCard('Tokens', fmtTokens(d.total_tokens)),
      statCard('Cost', fmtCost(d.total_cost_micros)),
      statCard('Errors', d.error_count),
      statCard('Error Rate', d.error_rate.toFixed(1) + '%'),
    ]);
    content.appendChild(grid);
    const note = el('div', { className: 'insights-empty', style: 'padding:16px;' }, 'Last ' + d.window_hours + ' hours');
    content.appendChild(note);
  } catch (e) {
    content.innerHTML = '<div class="insights-empty">Failed to load overview</div>';
  }
}

function statCard(label, value) {
  return el('div', { style: 'background:var(--surface-raised);border:1px solid var(--border);border-radius:8px;padding:16px;' }, [
    el('div', { style: 'font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px;' }, label),
    el('div', { style: 'font-size:20px;font-weight:600;color:var(--text);font-family:var(--mono);' }, String(value)),
  ]);
}

async function loadLlmUsage() {
  const content = document.getElementById('llmContent');
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/llm/usage?hours=24&limit=100' + (pp ? '&' + pp : ''));
    if (!r) return;
    const d = await r.json();
    content.innerHTML = '';
    if (!d.usage || !d.usage.length) {
      content.innerHTML = '<div class="insights-empty">No usage data in the last ' + d.window_hours + ' hours</div>';
      return;
    }
    const table = el('table', { style: 'width:100%;border-collapse:collapse;font-size:11px;' });
    const thead = el('tr', {}, [
      el('th', { style: 'text-align:left;padding:6px 4px;color:var(--text-dim);border-bottom:1px solid var(--border);' }, 'Time'),
      el('th', { style: 'text-align:left;padding:6px 4px;color:var(--text-dim);border-bottom:1px solid var(--border);' }, 'Model'),
      el('th', { style: 'text-align:right;padding:6px 4px;color:var(--text-dim);border-bottom:1px solid var(--border);' }, 'Spans'),
      el('th', { style: 'text-align:right;padding:6px 4px;color:var(--text-dim);border-bottom:1px solid var(--border);' }, 'Tokens'),
      el('th', { style: 'text-align:right;padding:6px 4px;color:var(--text-dim);border-bottom:1px solid var(--border);' }, 'Cost'),
    ]);
    table.appendChild(thead);
    d.usage.forEach(u => {
      table.appendChild(el('tr', {}, [
        el('td', { style: 'padding:6px 4px;color:var(--text);border-bottom:1px solid var(--border-subtle);' }, new Date(u.hour_bucket).toLocaleString()),
        el('td', { style: 'padding:6px 4px;color:var(--text);border-bottom:1px solid var(--border-subtle);' }, (u.model || '-') + (u.provider ? ' (' + u.provider + ')' : '')),
        el('td', { style: 'text-align:right;padding:6px 4px;color:var(--text);border-bottom:1px solid var(--border-subtle);font-family:var(--mono);' }, String(u.span_count)),
        el('td', { style: 'text-align:right;padding:6px 4px;color:var(--text);border-bottom:1px solid var(--border-subtle);font-family:var(--mono);' }, fmtTokens(u.total_tokens)),
        el('td', { style: 'text-align:right;padding:6px 4px;color:var(--text);border-bottom:1px solid var(--border-subtle);font-family:var(--mono);' }, fmtCost(u.cost_micros)),
      ]));
    });
    content.appendChild(table);
  } catch (e) {
    content.innerHTML = '<div class="insights-empty">Failed to load usage data</div>';
  }
}

async function loadLlmLatency() {
  const content = document.getElementById('llmContent');
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/llm/latency?hours=24' + (pp ? '&' + pp : ''));
    if (!r) return;
    const d = await r.json();
    content.innerHTML = '';
    if (!d.latency || !d.latency.length) {
      content.innerHTML = '<div class="insights-empty">No latency data in the last ' + d.window_hours + ' hours</div>';
      return;
    }
    const table = el('table', { style: 'width:100%;border-collapse:collapse;font-size:11px;' });
    const thead = el('tr', {}, [
      el('th', { style: 'text-align:left;padding:6px 4px;color:var(--text-dim);border-bottom:1px solid var(--border);' }, 'Model'),
      el('th', { style: 'text-align:right;padding:6px 4px;color:var(--text-dim);border-bottom:1px solid var(--border);' }, 'p50'),
      el('th', { style: 'text-align:right;padding:6px 4px;color:var(--text-dim);border-bottom:1px solid var(--border);' }, 'p90'),
      el('th', { style: 'text-align:right;padding:6px 4px;color:var(--text-dim);border-bottom:1px solid var(--border);' }, 'p99'),
      el('th', { style: 'text-align:right;padding:6px 4px;color:var(--text-dim);border-bottom:1px solid var(--border);' }, 'TTFT'),
      el('th', { style: 'text-align:right;padding:6px 4px;color:var(--text-dim);border-bottom:1px solid var(--border);' }, 'Calls'),
    ]);
    table.appendChild(thead);
    d.latency.forEach(l => {
      table.appendChild(el('tr', {}, [
        el('td', { style: 'padding:6px 4px;color:var(--text);border-bottom:1px solid var(--border-subtle);' }, l.model || '-'),
        el('td', { style: 'text-align:right;padding:6px 4px;color:var(--text);border-bottom:1px solid var(--border-subtle);font-family:var(--mono);' }, l.p50_ms.toFixed(0) + 'ms'),
        el('td', { style: 'text-align:right;padding:6px 4px;color:var(--text);border-bottom:1px solid var(--border-subtle);font-family:var(--mono);' }, l.p90_ms.toFixed(0) + 'ms'),
        el('td', { style: 'text-align:right;padding:6px 4px;color:var(--text);border-bottom:1px solid var(--border-subtle);font-family:var(--mono);' }, l.p99_ms.toFixed(0) + 'ms'),
        el('td', { style: 'text-align:right;padding:6px 4px;color:var(--text);border-bottom:1px solid var(--border-subtle);font-family:var(--mono);' }, l.avg_ttft_ms.toFixed(0) + 'ms'),
        el('td', { style: 'text-align:right;padding:6px 4px;color:var(--text);border-bottom:1px solid var(--border-subtle);font-family:var(--mono);' }, String(l.span_count)),
      ]));
    });
    content.appendChild(table);
  } catch (e) {
    content.innerHTML = '<div class="insights-empty">Failed to load latency data</div>';
  }
}

async function loadLlmModels() {
  const content = document.getElementById('llmContent');
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/llm/models?hours=24' + (pp ? '&' + pp : ''));
    if (!r) return;
    const d = await r.json();
    content.innerHTML = '';
    if (!d.models || !d.models.length) {
      content.innerHTML = '<div class="insights-empty">No model data in the last ' + d.window_hours + ' hours</div>';
      return;
    }

    // Fetch pricing for each unique model
    const pricingMap = {};
    const modelNames = [...new Set(d.models.map(m => m.model).filter(Boolean))];
    await Promise.allSettled(modelNames.map(async name => {
      try {
        const pr = await authFetch(API + '/v1/llm/pricing?model=' + encodeURIComponent(name));
        if (pr && pr.ok) pricingMap[name] = await pr.json();
      } catch (_) {}
    }));

    d.models.forEach(m => {
      const pricing = pricingMap[m.model];
      const pricingRow = [];
      if (pricing && pricing.input_cost_per_token != null) {
        const inCostM = (pricing.input_cost_per_token * 1000000).toFixed(2);
        const outCostM = (pricing.output_cost_per_token * 1000000).toFixed(2);
        pricingRow.push(
          el('div', { style: 'display:flex;gap:12px;font-size:10px;color:var(--text-dim);margin-top:6px;padding-top:6px;border-top:1px solid var(--border-subtle);' }, [
            el('span', {}, '$' + inCostM + '/M input'),
            el('span', {}, '$' + outCostM + '/M output'),
            pricing.source === 'override' ? el('span', { style: 'color:var(--accent-text);' }, 'custom pricing') : null,
          ].filter(Boolean))
        );
      }

      const card = el('div', { style: 'background:var(--surface-raised);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:8px;' }, [
        el('div', { style: 'display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;' }, [
          el('div', { style: 'font-size:13px;font-weight:600;color:var(--text);' }, (m.model || 'unknown') + (m.provider ? ' (' + m.provider + ')' : '')),
          el('div', { style: 'font-size:12px;font-family:var(--mono);color:var(--accent-text);' }, fmtCost(m.cost_micros)),
        ]),
        el('div', { style: 'display:flex;gap:16px;font-size:10px;color:var(--text-dim);' }, [
          el('span', {}, m.span_count + ' calls'),
          el('span', {}, fmtTokens(m.total_tokens) + ' tokens'),
          el('span', {}, m.avg_latency_ms.toFixed(0) + 'ms avg'),
          el('span', { style: m.error_rate > 0 ? 'color:var(--red-text);' : '' }, m.error_rate.toFixed(1) + '% errors'),
        ]),
        ...pricingRow,
      ]);
      content.appendChild(card);
    });
  } catch (e) {
    content.innerHTML = '<div class="insights-empty">Failed to load model data</div>';
  }
}

async function loadLlmTraces() {
  const content = document.getElementById('llmContent');
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/llm/traces?hours=24&limit=50' + (pp ? '&' + pp : ''));
    if (!r) return;
    const d = await r.json();
    content.innerHTML = '';
    if (!d.traces || !d.traces.length) {
      content.innerHTML = '<div class="insights-empty">No traces in the last ' + d.window_hours + ' hours</div>';
      return;
    }
    const note = el('div', { style: 'font-size:10px;color:var(--text-dim);margin-bottom:12px;' }, d.total + ' total traces');
    content.appendChild(note);
    d.traces.forEach(t => {
      const row = el('div', {
        style: 'padding:10px 0;border-bottom:1px solid var(--border-subtle);cursor:pointer;',
        onclick: function() { loadLlmTraceDetail(t.id); }
      }, [
        el('div', { style: 'display:flex;justify-content:space-between;align-items:center;' }, [
          el('div', { style: 'font-size:12px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:300px;' }, t.name || t.id),
          el('div', { style: 'font-size:10px;font-family:var(--mono);color:var(--accent-text);' }, fmtCost(t.cost_micros)),
        ]),
        el('div', { style: 'display:flex;gap:12px;font-size:10px;color:var(--text-dim);margin-top:2px;' }, [
          el('span', {}, t.span_count + ' spans'),
          el('span', {}, fmtTokens(t.total_tokens) + ' tokens'),
          el('span', { style: t.status === 'error' ? 'color:var(--red-text);' : '' }, t.status),
          el('span', {}, new Date(t.started_at).toLocaleString()),
        ]),
      ]);
      content.appendChild(row);
    });
  } catch (e) {
    content.innerHTML = '<div class="insights-empty">Failed to load traces</div>';
  }
}

async function loadLlmTraceDetail(traceId) {
  const content = document.getElementById('llmContent');
  content.innerHTML = '<div class="insights-loading">Loading trace...</div>';
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/llm/traces/' + traceId + (pp ? '?' + pp : ''));
    if (!r) return;
    const t = await r.json();
    content.innerHTML = '';

    // Back button
    const back = el('button', {
      className: 'logout-btn',
      style: 'margin-bottom:16px;font-size:11px;',
      onclick: function() { loadLlmTraces(); }
    }, '\u2190 Back to traces');
    content.appendChild(back);

    // Trace header
    const header = el('div', { style: 'margin-bottom:16px;' }, [
      el('div', { style: 'font-size:14px;font-weight:600;color:var(--text);margin-bottom:4px;' }, t.name || t.id),
      el('div', { style: 'display:flex;gap:12px;font-size:10px;color:var(--text-dim);' }, [
        el('span', {}, 'Status: ' + t.status),
        el('span', {}, fmtTokens(t.total_tokens) + ' tokens'),
        el('span', {}, fmtCost(t.cost_micros)),
        el('span', {}, new Date(t.started_at).toLocaleString()),
      ]),
    ]);
    content.appendChild(header);

    // Spans
    if (t.spans && t.spans.length) {
      const spanTitle = el('div', { style: 'font-size:11px;color:var(--text-dim);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.05em;' }, t.spans.length + ' Spans');
      content.appendChild(spanTitle);
      t.spans.forEach(s => {
        const card = el('div', { style: 'background:var(--surface-raised);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:6px;' }, [
          el('div', { style: 'display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;' }, [
            el('div', { style: 'font-size:12px;color:var(--text);' }, [
              el('span', { style: 'padding:2px 6px;border-radius:4px;font-size:9px;text-transform:uppercase;background:var(--accent-soft);color:var(--accent-text);margin-right:6px;' }, s.span_type),
              document.createTextNode(s.name || s.model || s.id),
            ]),
            el('div', { style: 'font-size:10px;font-family:var(--mono);color:var(--text-dim);' }, s.latency_ms + 'ms'),
          ]),
          el('div', { style: 'display:flex;gap:12px;font-size:10px;color:var(--text-dim);' }, [
            s.model ? el('span', {}, s.model) : null,
            el('span', {}, fmtTokens(s.total_tokens) + ' tokens'),
            el('span', {}, fmtCost(s.cost_micros)),
            s.status === 'error' ? el('span', { style: 'color:var(--red-text);' }, s.error_message || 'error') : el('span', {}, s.status),
            s.time_to_first_token_ms ? el('span', {}, 'TTFT: ' + s.time_to_first_token_ms + 'ms') : null,
          ].filter(Boolean)),
        ]);
        // RAG metadata for retrieval spans
        if (s.span_type === 'retrieval' && s.metadata) {
          const m = s.metadata;
          const hasRag = m['rag.chunks_retrieved'] != null || m['rag.source'] != null;
          if (hasRag) {
            const ragRow = el('div', { style: 'display:flex;gap:12px;font-size:10px;color:var(--text-dim);margin-top:6px;padding-top:6px;border-top:1px solid var(--border-subtle);' }, [
              m['rag.source'] ? el('span', {}, 'Source: ' + m['rag.source']) : null,
              m['rag.chunks_used'] != null && m['rag.chunks_retrieved'] != null ? el('span', {}, 'Chunks: ' + m['rag.chunks_used'] + '/' + m['rag.chunks_retrieved']) : null,
              m['rag.context_tokens'] != null ? el('span', {}, 'Context: ' + m['rag.context_tokens'] + ' tokens') : null,
              m['rag.max_context_tokens'] != null && m['rag.context_tokens'] != null ? el('span', {}, 'Utilization: ' + ((m['rag.context_tokens'] / m['rag.max_context_tokens']) * 100).toFixed(1) + '%') : null,
              m['rag.relevance_scores'] && m['rag.relevance_scores'].length ? el('span', {}, 'Top relevance: ' + m['rag.relevance_scores'][0].toFixed(3)) : null,
            ].filter(Boolean));
            card.appendChild(ragRow);
          }
        }
        content.appendChild(card);
      });
    }
  } catch (e) {
    content.innerHTML = '<div class="insights-empty">Failed to load trace detail</div>';
  }
}

// ── LLM Search Tab ──
async function loadLlmSearch() {
  const content = document.getElementById('llmContent');
  content.innerHTML = '';

  // Search input
  const input = el('input', {
    type: 'text',
    placeholder: 'Search traces...',
    style: 'width:100%;padding:8px 12px;font-size:12px;font-family:var(--mono);background:var(--surface-raised);color:var(--text);border:1px solid var(--border);border-radius:6px;box-sizing:border-box;outline:none;margin-bottom:12px;',
  });
  content.appendChild(input);

  const resultsDiv = el('div', { style: '' });
  resultsDiv.innerHTML = '<div class="insights-empty">Enter a query to search traces</div>';
  content.appendChild(resultsDiv);

  async function doSearch() {
    const q = input.value.trim();
    if (!q) {
      resultsDiv.innerHTML = '<div class="insights-empty">Enter a query to search traces</div>';
      return;
    }
    resultsDiv.innerHTML = '<div class="insights-loading">Searching...</div>';
    try {
      const pp = projectParam();
      const r = await authFetch(API + '/v1/llm/search?q=' + encodeURIComponent(q) + '&hours=24' + (pp ? '&' + pp : ''));
      if (!r) return;
      const d = await r.json();
      resultsDiv.innerHTML = '';
      if (!d.traces || !d.traces.length) {
        resultsDiv.innerHTML = '<div class="insights-empty">No traces found for "' + q + '"</div>';
        return;
      }
      const note = el('div', { style: 'font-size:10px;color:var(--text-dim);margin-bottom:12px;' }, d.total + ' matching traces');
      resultsDiv.appendChild(note);
      d.traces.forEach(t => {
        const row = el('div', {
          style: 'padding:10px 0;border-bottom:1px solid var(--border-subtle);cursor:pointer;',
          onclick: function() { loadLlmTraceDetail(t.id); }
        }, [
          el('div', { style: 'display:flex;justify-content:space-between;align-items:center;' }, [
            el('div', { style: 'font-size:12px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:300px;' }, t.name || t.id),
            el('div', { style: 'font-size:10px;font-family:var(--mono);color:var(--accent-text);' }, fmtCost(t.cost_micros)),
          ]),
          el('div', { style: 'display:flex;gap:12px;font-size:10px;color:var(--text-dim);margin-top:2px;' }, [
            el('span', {}, t.span_count + ' spans'),
            el('span', {}, fmtTokens(t.total_tokens) + ' tokens'),
            el('span', { style: t.status === 'error' ? 'color:var(--red-text);' : '' }, t.status),
            el('span', {}, new Date(t.started_at).toLocaleString()),
          ]),
        ]);
        resultsDiv.appendChild(row);
      });
    } catch (e) {
      resultsDiv.innerHTML = '<div class="insights-empty">Search failed</div>';
    }
  }

  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') doSearch();
  });
  input.focus();
}

// ── LLM Prompts Tab ──
async function loadLlmPrompts() {
  const content = document.getElementById('llmContent');
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/llm/prompts?hours=24' + (pp ? '&' + pp : ''));
    if (!r) return;
    const d = await r.json();
    content.innerHTML = '';
    if (!d.prompts || !d.prompts.length) {
      content.innerHTML = '<div class="insights-empty">No prompt data in the last 24 hours</div>';
      return;
    }
    const table = el('table', { style: 'width:100%;border-collapse:collapse;font-size:11px;' });
    const thead = el('tr', {}, [
      el('th', { style: 'text-align:left;padding:6px 8px;color:var(--text-dim);font-weight:500;border-bottom:1px solid var(--border);' }, 'Prompt Name'),
      el('th', { style: 'text-align:right;padding:6px 8px;color:var(--text-dim);font-weight:500;border-bottom:1px solid var(--border);' }, 'Versions'),
      el('th', { style: 'text-align:right;padding:6px 8px;color:var(--text-dim);font-weight:500;border-bottom:1px solid var(--border);' }, 'Traces'),
      el('th', { style: 'text-align:right;padding:6px 8px;color:var(--text-dim);font-weight:500;border-bottom:1px solid var(--border);' }, 'Avg Cost'),
      el('th', { style: 'text-align:right;padding:6px 8px;color:var(--text-dim);font-weight:500;border-bottom:1px solid var(--border);' }, 'Error Rate'),
    ]);
    table.appendChild(thead);
    const tbody = el('tbody');
    d.prompts.forEach(p => {
      const tr = el('tr', {}, [
        el('td', { style: 'padding:6px 8px;color:var(--text);font-weight:600;' }, p.name || 'unknown'),
        el('td', { style: 'padding:6px 8px;text-align:right;color:var(--text-dim);font-family:var(--mono);' }, String(p.version_count || '-')),
        el('td', { style: 'padding:6px 8px;text-align:right;color:var(--text);font-family:var(--mono);' }, String(p.total_traces)),
        el('td', { style: 'padding:6px 8px;text-align:right;color:var(--accent-text);font-family:var(--mono);' }, fmtCost(p.avg_cost_micros)),
        el('td', { style: 'padding:6px 8px;text-align:right;font-family:var(--mono);' + (p.error_rate > 0 ? 'color:var(--red-text);' : 'color:var(--text-dim);') }, p.error_rate.toFixed(1) + '%'),
      ]);
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    content.appendChild(table);
  } catch (e) {
    content.innerHTML = '<div class="insights-empty">Failed to load prompt data</div>';
  }
}

// ── LLM RAG Tab ──
async function loadLlmRag() {
  const content = document.getElementById('llmContent');
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/llm/rag?hours=24' + (pp ? '&' + pp : ''));
    if (!r) return;
    const d = await r.json();
    content.innerHTML = '';

    // Stat cards
    const totalRetrievals = d.relevance ? d.relevance.total_retrievals : 0;
    const avgTopRelevance = d.relevance ? d.relevance.avg_top_relevance : 0;
    const avgChunksRetrieved = d.relevance ? d.relevance.avg_chunks_retrieved : 0;
    const chunkUtil = d.relevance ? d.relevance.chunk_utilization_pct : 0;

    if (totalRetrievals === 0) {
      content.innerHTML = '<div class="insights-empty">No RAG data in the last ' + d.window_hours + ' hours</div>';
      return;
    }

    const cards = el('div', { style: 'display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;' }, [
      el('div', { style: 'background:var(--surface-raised);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;' }, [
        el('div', { style: 'font-size:18px;font-weight:700;color:var(--text);' }, String(totalRetrievals)),
        el('div', { style: 'font-size:10px;color:var(--text-dim);margin-top:2px;' }, 'Total Retrievals'),
      ]),
      el('div', { style: 'background:var(--surface-raised);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;' }, [
        el('div', { style: 'font-size:18px;font-weight:700;color:var(--text);' }, avgTopRelevance.toFixed(3)),
        el('div', { style: 'font-size:10px;color:var(--text-dim);margin-top:2px;' }, 'Avg Top Relevance'),
      ]),
      el('div', { style: 'background:var(--surface-raised);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;' }, [
        el('div', { style: 'font-size:18px;font-weight:700;color:var(--text);' }, avgChunksRetrieved.toFixed(1)),
        el('div', { style: 'font-size:10px;color:var(--text-dim);margin-top:2px;' }, 'Avg Chunks Retrieved'),
      ]),
      el('div', { style: 'background:var(--surface-raised);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;' }, [
        el('div', { style: 'font-size:18px;font-weight:700;color:' + (chunkUtil > 80 ? 'var(--red-text)' : 'var(--text)') + ';' }, chunkUtil.toFixed(1) + '%'),
        el('div', { style: 'font-size:10px;color:var(--text-dim);margin-top:2px;' }, 'Chunk Utilization'),
      ]),
    ]);
    content.appendChild(cards);

    // Source table
    if (d.sources && d.sources.length) {
      const table = el('table', { style: 'width:100%;border-collapse:collapse;font-size:11px;' });
      const thead = el('tr', {}, [
        el('th', { style: 'text-align:left;padding:6px 8px;color:var(--text-dim);font-weight:500;border-bottom:1px solid var(--border);' }, 'Name'),
        el('th', { style: 'text-align:left;padding:6px 8px;color:var(--text-dim);font-weight:500;border-bottom:1px solid var(--border);' }, 'Source'),
        el('th', { style: 'text-align:right;padding:6px 8px;color:var(--text-dim);font-weight:500;border-bottom:1px solid var(--border);' }, 'Calls'),
        el('th', { style: 'text-align:right;padding:6px 8px;color:var(--text-dim);font-weight:500;border-bottom:1px solid var(--border);' }, 'Avg Latency'),
        el('th', { style: 'text-align:right;padding:6px 8px;color:var(--text-dim);font-weight:500;border-bottom:1px solid var(--border);' }, 'P95'),
        el('th', { style: 'text-align:right;padding:6px 8px;color:var(--text-dim);font-weight:500;border-bottom:1px solid var(--border);' }, 'Chunks'),
        el('th', { style: 'text-align:right;padding:6px 8px;color:var(--text-dim);font-weight:500;border-bottom:1px solid var(--border);' }, 'Ctx Tokens'),
        el('th', { style: 'text-align:right;padding:6px 8px;color:var(--text-dim);font-weight:500;border-bottom:1px solid var(--border);' }, 'Utilization'),
        el('th', { style: 'text-align:right;padding:6px 8px;color:var(--text-dim);font-weight:500;border-bottom:1px solid var(--border);' }, 'Error Rate'),
      ]);
      table.appendChild(thead);
      d.sources.forEach(s => {
        const utilPct = s.avg_context_utilization_pct || 0;
        table.appendChild(el('tr', {}, [
          el('td', { style: 'padding:6px 8px;color:var(--text);font-weight:600;border-bottom:1px solid var(--border-subtle);' }, s.retrieval_name || '-'),
          el('td', { style: 'padding:6px 8px;color:var(--text-dim);border-bottom:1px solid var(--border-subtle);' }, s.source || '-'),
          el('td', { style: 'text-align:right;padding:6px 8px;color:var(--text);font-family:var(--mono);border-bottom:1px solid var(--border-subtle);' }, String(s.call_count)),
          el('td', { style: 'text-align:right;padding:6px 8px;color:var(--text);font-family:var(--mono);border-bottom:1px solid var(--border-subtle);' }, s.avg_latency_ms.toFixed(0) + 'ms'),
          el('td', { style: 'text-align:right;padding:6px 8px;color:var(--text);font-family:var(--mono);border-bottom:1px solid var(--border-subtle);' }, s.p95_latency_ms.toFixed(0) + 'ms'),
          el('td', { style: 'text-align:right;padding:6px 8px;color:var(--text);font-family:var(--mono);border-bottom:1px solid var(--border-subtle);' }, s.avg_chunks_retrieved.toFixed(1)),
          el('td', { style: 'text-align:right;padding:6px 8px;color:var(--text);font-family:var(--mono);border-bottom:1px solid var(--border-subtle);' }, s.avg_context_tokens.toFixed(0)),
          el('td', { style: 'text-align:right;padding:6px 8px;font-family:var(--mono);border-bottom:1px solid var(--border-subtle);color:' + (utilPct > 80 ? 'var(--red-text)' : 'var(--text)') + ';' }, utilPct.toFixed(1) + '%'),
          el('td', { style: 'text-align:right;padding:6px 8px;font-family:var(--mono);border-bottom:1px solid var(--border-subtle);' + (s.error_rate > 0 ? 'color:var(--red-text);' : 'color:var(--text-dim);') }, s.error_rate.toFixed(1) + '%'),
        ]));
      });
      content.appendChild(table);
    }

    // Relevance summary bar
    if (d.relevance && d.relevance.total_retrievals > 0) {
      const rel = d.relevance;
      const pct = Math.max(0, Math.min(100, rel.avg_top_relevance * 100));
      const barColor = pct >= 70 ? 'var(--green, #4ade80)' : pct >= 40 ? 'var(--yellow, #facc15)' : 'var(--red-text, #f87171)';
      const relCard = el('div', { style: 'background:var(--surface-raised);border:1px solid var(--border);border-radius:8px;padding:14px;margin-top:12px;' }, [
        el('div', { style: 'font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px;' }, 'Relevance Distribution'),
        el('div', { style: 'display:flex;justify-content:space-between;font-size:10px;color:var(--text-dim);margin-bottom:4px;' }, [
          el('span', {}, 'Avg: ' + rel.avg_top_relevance.toFixed(3)),
          el('span', {}, 'Min: ' + rel.min_top_relevance.toFixed(3) + ' / Max: ' + rel.max_top_relevance.toFixed(3)),
        ]),
        (() => {
          const bar = el('div', { style: 'width:100%;height:8px;background:var(--border);border-radius:4px;overflow:hidden;' });
          const fill = el('div', { style: 'height:100%;width:' + pct + '%;background:' + barColor + ';border-radius:4px;' });
          bar.appendChild(fill);
          return bar;
        })(),
        el('div', { style: 'display:flex;gap:16px;font-size:10px;color:var(--text-dim);margin-top:8px;' }, [
          el('span', {}, 'Avg chunks retrieved: ' + rel.avg_chunks_retrieved.toFixed(1)),
          el('span', {}, 'Avg chunks used: ' + rel.avg_chunks_used.toFixed(1)),
          el('span', {}, 'Chunk utilization: ' + rel.chunk_utilization_pct.toFixed(1) + '%'),
        ]),
      ]);
      content.appendChild(relCard);
    }
  } catch (e) {
    content.innerHTML = '<div class="insights-empty">Failed to load RAG data</div>';
  }
}

// ── LLM Scores Tab ──
async function loadLlmScores() {
  const content = document.getElementById('llmContent');
  try {
    const pp = projectParam();
    // Fetch summaries for known score names in parallel
    const scoreNames = ['quality', 'relevance', 'helpfulness', 'accuracy', 'toxicity', 'coherence'];
    const fetches = scoreNames.map(name =>
      authFetch(API + '/v1/llm/scores/summary?hours=24&name=' + name + (pp ? '&' + pp : ''))
        .then(r => r ? r.json() : null)
        .catch(() => null)
    );
    const results = await Promise.all(fetches);
    const scores = results.filter(s => s && s.count > 0);
    content.innerHTML = '';
    if (!scores.length) {
      content.innerHTML = '<div class="insights-empty">No score data in the last 24 hours</div>';
      return;
    }
    scores.forEach(s => {
      const pct = Math.max(0, Math.min(100, s.avg * 100));
      const barColor = pct >= 70 ? 'var(--green, #4ade80)' : pct >= 40 ? 'var(--yellow, #facc15)' : 'var(--red-text, #f87171)';
      const card = el('div', { style: 'background:var(--surface-raised);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:8px;' }, [
        el('div', { style: 'display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;' }, [
          el('div', { style: 'font-size:13px;font-weight:600;color:var(--text);' }, s.name),
          el('div', { style: 'font-size:10px;color:var(--text-dim);' }, s.count + ' scores'),
        ]),
        // Average bar visualization (0-1 scale)
        el('div', { style: 'margin-bottom:10px;' }, [
          el('div', { style: 'display:flex;justify-content:space-between;font-size:10px;color:var(--text-dim);margin-bottom:4px;' }, [
            el('span', {}, 'Avg: ' + s.avg.toFixed(3)),
            el('span', {}, (pct).toFixed(1) + '%'),
          ]),
          (() => {
            const bar = el('div', { style: 'width:100%;height:8px;background:var(--border);border-radius:4px;overflow:hidden;' });
            const fill = el('div', { style: 'height:100%;width:' + pct + '%;background:' + barColor + ';border-radius:4px;transition:width 0.3s ease;' });
            bar.appendChild(fill);
            return bar;
          })(),
        ]),
        // P10 / P50 / P90
        el('div', { style: 'display:flex;gap:16px;font-size:10px;color:var(--text-dim);' }, [
          el('span', {}, 'P10: ' + s.p10.toFixed(3)),
          el('span', {}, 'P50: ' + s.p50.toFixed(3)),
          el('span', {}, 'P90: ' + s.p90.toFixed(3)),
        ]),
      ]);
      content.appendChild(card);
    });
  } catch (e) {
    content.innerHTML = '<div class="insights-empty">Failed to load score data</div>';
  }
}

// ── LLM Experiments Tab ──
async function loadLlmExperiments() {
  const content = document.getElementById('llmContent');
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/llm/experiments' + (pp ? '?' + pp : ''));
    if (!r) return;
    const experiments = await r.json();
    content.innerHTML = '';
    
    // Header with create button
    const header = el('div', { style: 'display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;' }, [
      el('div', { style: 'font-size:11px;color:var(--text-dim);' }, (experiments.experiments?.length || 0) + ' experiments'),
      el('button', { 
        style: 'font-family:var(--mono);font-size:11px;padding:6px 12px;background:var(--accent);color:var(--bg);border:none;border-radius:6px;cursor:pointer;',
        onclick: () => showCreateExperimentForm()
      }, '+ New Experiment'),
    ]);
    content.appendChild(header);
    
    if (!experiments.experiments || !experiments.experiments.length) {
      content.innerHTML += '<div class="insights-empty">No experiments yet. Create one to start A/B testing prompts.</div>';
      return;
    }
    
    // List experiments
    experiments.experiments.forEach(exp => {
      const card = el('div', { 
        style: 'background:var(--surface-raised);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:10px;cursor:pointer;',
        onclick: () => loadExperimentDetail(exp.id)
      }, [
        el('div', { style: 'display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;' }, [
          el('div', { style: 'font-size:13px;font-weight:600;color:var(--text);' }, exp.name),
          el('div', { 
            style: 'font-size:10px;padding:2px 8px;border-radius:4px;background:' + (exp.status === 'active' ? 'var(--green-soft)' : 'var(--muted-soft)') + ';color:' + (exp.status === 'active' ? 'var(--green-text)' : 'var(--text-dim)') + ';'
          }, exp.status),
        ]),
        el('div', { style: 'font-size:11px;color:var(--text-dim);margin-bottom:8px;' }, exp.description || 'No description'),
        el('div', { style: 'display:flex;gap:16px;font-size:10px;color:var(--text-secondary);' }, [
          el('span', {}, 'Prompt: ' + exp.prompt_name),
          el('span', {}, exp.variant_count + ' variants'),
          el('span', {}, new Date(exp.updated_at).toLocaleDateString()),
        ]),
      ]);
      content.appendChild(card);
    });
  } catch (e) {
    content.innerHTML = '<div class="insights-empty">Failed to load experiments</div>';
  }
}

async function loadExperimentDetail(expId) {
  const content = document.getElementById('llmContent');
  content.innerHTML = '<div class="insights-loading">Loading experiment...</div>';
  
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/llm/experiments/' + expId + (pp ? '?' + pp : ''));
    if (!r) return;
    const exp = await r.json();
    
    content.innerHTML = '';
    
    // Back button
    const backBtn = el('button', { 
      style: 'font-family:var(--mono);font-size:11px;padding:6px 12px;background:transparent;color:var(--text-dim);border:1px solid var(--border);border-radius:6px;cursor:pointer;margin-bottom:12px;',
      onclick: () => loadLlmExperiments()
    }, '← Back to experiments');
    content.appendChild(backBtn);
    
    // Header
    const header = el('div', { style: 'margin-bottom:16px;' }, [
      el('h3', { style: 'font-family:var(--display);font-size:20px;color:var(--text);margin-bottom:6px;' }, exp.name),
      el('div', { style: 'font-size:11px;color:var(--text-dim);' }, exp.description || 'No description'),
    ]);
    content.appendChild(header);
    
    // Overall metrics
    if (exp.metrics) {
      const metrics = el('div', { style: 'display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;' }, [
        el('div', { style: 'background:var(--surface-raised);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;' }, [
          el('div', { style: 'font-size:18px;font-weight:700;color:var(--text);' }, String(exp.metrics.total_calls || 0)),
          el('div', { style: 'font-size:10px;color:var(--text-dim);margin-top:2px;' }, 'Total Calls'),
        ]),
        el('div', { style: 'background:var(--surface-raised);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;' }, [
          el('div', { style: 'font-size:18px;font-weight:700;color:var(--text);' }, fmtCost(exp.metrics.total_cost_micros || 0)),
          el('div', { style: 'font-size:10px;color:var(--text-dim);margin-top:2px;' }, 'Total Cost'),
        ]),
        el('div', { style: 'background:var(--surface-raised);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;' }, [
          el('div', { style: 'font-size:18px;font-weight:700;color:var(--text);' }, (exp.metrics.p95_latency_ms || 0).toFixed(0) + 'ms'),
          el('div', { style: 'font-size:10px;color:var(--text-dim);margin-top:2px;' }, 'P95 Latency'),
        ]),
        el('div', { style: 'background:var(--surface-raised);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;' }, [
          el('div', { style: 'font-size:18px;font-weight:700;color:var(--text);' }, (exp.metrics.overall_success_rate || 0).toFixed(1) + '%'),
          el('div', { style: 'font-size:10px;color:var(--text-dim);margin-top:2px;' }, 'Success Rate'),
        ]),
      ]);
      content.appendChild(metrics);
    }
    
    // Variants
    if (exp.variants && exp.variants.length) {
      const variantsTitle = el('div', { style: 'font-size:11px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:10px;' }, 'Variants');
      content.appendChild(variantsTitle);
      
      exp.variants.forEach((variant, idx) => {
        const vCard = el('div', { style: 'background:var(--surface-raised);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:10px;' }, [
          el('div', { style: 'display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;' }, [
            el('div', { style: 'font-size:12px;font-weight:600;color:var(--text);' }, variant.name + ' (' + variant.version + ')'),
            el('div', { style: 'font-size:10px;color:var(--text-dim);' }, variant.traffic_percentage + '% traffic'),
          ]),
          el('div', { style: 'font-size:10px;color:var(--text-secondary);margin-bottom:8px;font-family:var(--mono);' }, variant.prompt_template.substring(0, 100) + (variant.prompt_template.length > 100 ? '...' : '')),
          el('div', { style: 'display:flex;gap:16px;font-size:10px;color:var(--text-secondary);' }, [
            el('span', {}, 'Calls: ' + (variant.metrics?.total_calls || 0)),
            el('span', {}, 'Latency: ' + (variant.metrics?.avg_latency_ms || 0).toFixed(0) + 'ms'),
            el('span', {}, 'Cost: ' + fmtCost((variant.metrics?.avg_cost_per_call || 0) * 1000000)),
            el('span', {}, 'Success: ' + (variant.metrics?.success_rate || 0).toFixed(1) + '%'),
          ]),
        ]);
        content.appendChild(vCard);
        
        // Add compare button if there's more than one variant
        if (idx > 0 && exp.variants[0]) {
          const compareBtn = el('button', {
            style: 'font-family:var(--mono);font-size:10px;padding:4px 10px;background:var(--surface);color:var(--text-secondary);border:1px solid var(--border);border-radius:4px;cursor:pointer;margin-top:4px;',
            onclick: () => compareVariants(expId, exp.variants[0].version, variant.version)
          }, 'Compare with ' + exp.variants[0].name);
          vCard.appendChild(compareBtn);
        }
      });
    }
  } catch (e) {
    content.innerHTML = '<div class="insights-empty">Failed to load experiment details</div>';
  }
}

async function compareVariants(expId, baseline, treatment) {
  const content = document.getElementById('llmContent');
  content.innerHTML = '<div class="insights-loading">Comparing variants...</div>';
  
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/llm/experiments/' + expId + '/compare?baseline=' + baseline + '&treatment=' + treatment + (pp ? '&' + pp : ''));
    if (!r) return;
    const result = await r.json();
    
    content.innerHTML = '';
    
    // Back button
    const backBtn = el('button', { 
      style: 'font-family:var(--mono);font-size:11px;padding:6px 12px;background:transparent;color:var(--text-dim);border:1px solid var(--border);border-radius:6px;cursor:pointer;margin-bottom:12px;',
      onclick: () => loadExperimentDetail(expId)
    }, '← Back to experiment');
    content.appendChild(backBtn);
    
    // Comparison header
    const header = el('div', { style: 'margin-bottom:16px;' }, [
      el('h3', { style: 'font-family:var(--display);font-size:18px;color:var(--text);margin-bottom:6px;' }, 'Comparison: ' + result.baseline_variant + ' vs ' + result.treatment_variant),
    ]);
    content.appendChild(header);
    
    // Metrics comparison
    const metrics = result.metrics;
    const compCard = el('div', { style: 'background:var(--surface-raised);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:12px;' }, [
      el('div', { style: 'font-size:11px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:10px;' }, 'Metric Changes'),
      el('div', { style: 'display:flex;flex-direction:column;gap:8px;' }, [
        el('div', { style: 'display:flex;justify-content:space-between;font-size:12px;' }, [
          el('span', { style: 'color:var(--text);' }, 'Latency Change'),
          el('span', { style: 'color:' + (metrics.latency_improvement_percent < 0 ? 'var(--green-text)' : 'var(--red-text)') + ';' }, 
            (metrics.latency_improvement_percent > 0 ? '+' : '') + metrics.latency_improvement_percent.toFixed(1) + '%'),
        ]),
        el('div', { style: 'display:flex;justify-content:space-between;font-size:12px;' }, [
          el('span', { style: 'color:var(--text);' }, 'Cost Change'),
          el('span', { style: 'color:' + (metrics.cost_improvement_percent < 0 ? 'var(--green-text)' : 'var(--red-text)') + ';' }, 
            (metrics.cost_improvement_percent > 0 ? '+' : '') + metrics.cost_improvement_percent.toFixed(1) + '%'),
        ]),
        el('div', { style: 'display:flex;justify-content:space-between;font-size:12px;' }, [
          el('span', { style: 'color:var(--text);' }, 'Success Rate Change'),
          el('span', { style: 'color:' + (metrics.success_rate_improvement_percent > 0 ? 'var(--green-text)' : 'var(--red-text)') + ';' }, 
            (metrics.success_rate_improvement_percent > 0 ? '+' : '') + metrics.success_rate_improvement_percent.toFixed(1) + '%'),
        ]),
        el('div', { style: 'display:flex;justify-content:space-between;font-size:12px;' }, [
          el('span', { style: 'color:var(--text);' }, 'Sample Size'),
          el('span', { style: 'color:var(--text-secondary);' }, metrics.sample_size + ' calls'),
        ]),
      ]),
    ]);
    content.appendChild(compCard);
    
    // Statistical significance
    const sig = result.statistical_significance;
    const sigCard = el('div', { 
      style: 'background:var(--surface-raised);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:12px;'
    }, [
      el('div', { style: 'font-size:11px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:10px;' }, 'Statistical Significance'),
      el('div', { style: 'display:flex;flex-direction:column;gap:8px;font-size:12px;' }, [
        el('div', { style: 'display:flex;justify-content:space-between;' }, [
          el('span', { style: 'color:var(--text);' }, 'P-Value'),
          el('span', { style: 'color:var(--text-secondary);' }, sig.p_value.toFixed(3)),
        ]),
        el('div', { style: 'display:flex;justify-content:space-between;' }, [
          el('span', { style: 'color:var(--text);' }, 'Confidence Level'),
          el('span', { style: 'color:var(--text-secondary);' }, (sig.confidence_level * 100).toFixed(0) + '%'),
        ]),
        el('div', { style: 'display:flex;justify-content:space-between;' }, [
          el('span', { style: 'color:var(--text);' }, 'Significant'),
          el('span', { style: 'color:' + (sig.is_significant ? 'var(--green-text)' : 'var(--text-dim)') + ';' }, sig.is_significant ? 'Yes' : 'No'),
        ]),
      ]),
    ]);
    content.appendChild(sigCard);
    
    // Recommendation
    const recCard = el('div', { 
      style: 'background:' + (sig.is_significant ? 'var(--green-soft)' : 'var(--muted-soft)') + ';border:1px solid ' + (sig.is_significant ? 'var(--green)' : 'var(--border)') + ';border-radius:8px;padding:14px;'
    }, [
      el('div', { style: 'font-size:11px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px;' }, 'Recommendation'),
      el('div', { style: 'font-size:12px;color:var(--text);' }, result.recommendation),
    ]);
    content.appendChild(recCard);
    
  } catch (e) {
    content.innerHTML = '<div class="insights-empty">Failed to compare variants</div>';
  }
}

function showCreateExperimentForm() {
  const content = document.getElementById('llmContent');
  content.innerHTML = '';
  
  const backBtn = el('button', { 
    style: 'font-family:var(--mono);font-size:11px;padding:6px 12px;background:transparent;color:var(--text-dim);border:1px solid var(--border);border-radius:6px;cursor:pointer;margin-bottom:12px;',
    onclick: () => loadLlmExperiments()
  }, '← Back to experiments');
  content.appendChild(backBtn);
  
  const form = el('div', { style: 'background:var(--surface-raised);border:1px solid var(--border);border-radius:8px;padding:16px;' }, [
    el('h3', { style: 'font-family:var(--display);font-size:18px;color:var(--text);margin-bottom:16px;' }, 'Create Experiment'),
    
    el('div', { style: 'margin-bottom:12px;' }, [
      el('label', { style: 'display:block;font-size:11px;color:var(--text-dim);margin-bottom:4px;' }, 'Name'),
      el('input', { type: 'text', id: 'expName', style: 'width:100%;font-family:var(--mono);font-size:12px;padding:8px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);' }),
    ]),
    
    el('div', { style: 'margin-bottom:12px;' }, [
      el('label', { style: 'display:block;font-size:11px;color:var(--text-dim);margin-bottom:4px;' }, 'Description'),
      el('input', { type: 'text', id: 'expDesc', style: 'width:100%;font-family:var(--mono);font-size:12px;padding:8px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);' }),
    ]),
    
    el('div', { style: 'margin-bottom:12px;' }, [
      el('label', { style: 'display:block;font-size:11px;color:var(--text-dim);margin-bottom:4px;' }, 'Prompt Name'),
      el('input', { type: 'text', id: 'expPromptName', placeholder: 'e.g., summarizer', style: 'width:100%;font-family:var(--mono);font-size:12px;padding:8px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);' }),
    ]),
    
    el('div', { style: 'margin-bottom:16px;' }, [
      el('label', { style: 'display:block;font-size:11px;color:var(--text-dim);margin-bottom:8px;' }, 'Variants'),
      el('div', { id: 'expVariants', style: 'display:flex;flex-direction:column;gap:8px;' }, [
        createVariantInput(0),
        createVariantInput(1),
      ]),
    ]),
    
    el('button', {
      style: 'font-family:var(--mono);font-size:12px;padding:10px 20px;background:var(--accent);color:var(--bg);border:none;border-radius:6px;cursor:pointer;width:100%;',
      onclick: () => submitExperiment()
    }, 'Create Experiment'),
  ]);
  
  content.appendChild(form);
}

function createVariantInput(idx) {
  return el('div', { style: 'background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:10px;' }, [
    el('div', { style: 'font-size:10px;font-weight:600;color:var(--text-dim);margin-bottom:6px;' }, 'Variant ' + (idx + 1)),
    el('input', { type: 'text', placeholder: 'Name', className: 'var-name-' + idx, style: 'width:100%;font-family:var(--mono);font-size:11px;padding:6px;margin-bottom:6px;background:var(--surface-raised);border:1px solid var(--border);border-radius:4px;color:var(--text);' }),
    el('input', { type: 'text', placeholder: 'Version (e.g., v1)', className: 'var-version-' + idx, style: 'width:100%;font-family:var(--mono);font-size:11px;padding:6px;margin-bottom:6px;background:var(--surface-raised);border:1px solid var(--border);border-radius:4px;color:var(--text);' }),
    el('input', { type: 'text', placeholder: 'Prompt template', className: 'var-template-' + idx, style: 'width:100%;font-family:var(--mono);font-size:11px;padding:6px;margin-bottom:6px;background:var(--surface-raised);border:1px solid var(--border);border-radius:4px;color:var(--text);' }),
    el('input', { type: 'number', placeholder: 'Traffic %', className: 'var-traffic-' + idx, value: idx === 0 ? '50' : '50', style: 'width:100%;font-family:var(--mono);font-size:11px;padding:6px;background:var(--surface-raised);border:1px solid var(--border);border-radius:4px;color:var(--text);' }),
  ]);
}

async function submitExperiment() {
  const name = document.getElementById('expName').value;
  const description = document.getElementById('expDesc').value;
  const promptName = document.getElementById('expPromptName').value;
  
  if (!name || !promptName) {
    showToast('Name and prompt name are required', 'error');
    return;
  }
  
  const variants = [];
  for (let i = 0; i < 2; i++) {
    const name = document.querySelector('.var-name-' + i).value;
    const version = document.querySelector('.var-version-' + i).value;
    const template = document.querySelector('.var-template-' + i).value;
    const traffic = parseFloat(document.querySelector('.var-traffic-' + i).value) || 50;
    
    if (name && version && template) {
      variants.push({ name, version, prompt_template: template, traffic_percentage: traffic });
    }
  }
  
  if (variants.length < 2) {
    showToast('At least 2 variants are required', 'error');
    return;
  }
  
  try {
    const pp = projectParam();
    const r = await authFetch(API + '/v1/llm/experiments' + (pp ? '?' + pp : ''), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, description, prompt_name: promptName, variants })
    });
    
    if (r && r.ok) {
      showToast('Experiment created successfully', 'success');
      loadLlmExperiments();
    } else {
      showToast('Failed to create experiment', 'error');
    }
  } catch (e) {
    showToast('Error creating experiment', 'error');
  }
}

</script>
</body>
</html>
